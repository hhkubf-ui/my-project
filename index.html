<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡œì íŠ¸ í•™ìŠµ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 26px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 8px;
            border-radius: 4px;
            margin-top: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: #4ade80;
            height: 100%;
            transition: width 0.5s ease;
            width: 0%;
        }

        .content {
            padding: 40px;
        }

        .step-indicator {
            background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
            color: #667eea;
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 30px;
            text-align: center;
            border: 2px solid #667eea;
        }

        .save-status {
            background: #f0fdf4;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            color: #15803d;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid #86efac;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .input-group label .required {
            color: #ef4444;
        }

        .input-field {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-small {
            width: 150px;
            display: inline-block;
            margin-right: 10px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .checkbox-item:hover {
            background: #f3f4f6;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            cursor: pointer;
        }

        .checkbox-item.checked {
            background: #ede9fe;
            border-color: #667eea;
        }

        .task-card {
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .task-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .task-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
        }

        .task-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .task-card-title {
            font-size: 17px;
            font-weight: 600;
            color: #1f2937;
        }

        .task-card-badges {
            display: flex;
            gap: 8px;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-difficulty-low {
            background: #dcfce7;
            color: #15803d;
        }

        .badge-difficulty-mid {
            background: #fef3c7;
            color: #b45309;
        }

        .badge-difficulty-high {
            background: #fee2e2;
            color: #b91c1c;
        }

        .badge-time {
            background: #dbeafe;
            color: #1e40af;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .timeline {
            margin-top: 30px;
        }

        .timeline-item {
            background: #f9fafb;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .timeline-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        .timeline-time {
            font-size: 14px;
            color: #6b7280;
        }

        .timeline-activities {
            list-style: none;
            padding-left: 0;
        }

        .timeline-activities li {
            padding: 6px 0;
            color: #4b5563;
            font-size: 14px;
        }

        .timeline-activities li:before {
            content: "âœ“ ";
            color: #10b981;
            font-weight: bold;
            margin-right: 8px;
        }

        .hint-section {
            background: #fffbeb;
            border: 2px solid #fbbf24;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .hint-section summary {
            font-weight: 600;
            color: #b45309;
            cursor: pointer;
            user-select: none;
        }

        .hint-list {
            margin-top: 12px;
            padding-left: 20px;
        }

        .hint-list li {
            margin-bottom: 8px;
            color: #78350f;
            line-height: 1.6;
        }

        .report-box {
            background: #f0fdf4;
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.8;
            max-height: 500px;
            overflow-y: auto;
        }

        .nav-steps {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-step {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #e5e7eb;
            background: white;
        }

        .nav-step.completed {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .nav-step.current {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .nav-step:hover {
            border-color: #667eea;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1f2937;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .data-summary {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .data-summary h3 {
            color: #b45309;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .data-summary-item {
            padding: 6px 0;
            color: #78350f;
            font-size: 14px;
        }

        .data-summary-item strong {
            color: #92400e;
        }

        .custom-input-section {
            background: #f0f9ff;
            border: 2px dashed #3b82f6;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .custom-input-section h4 {
            color: #1e40af;
            margin-bottom: 12px;
        }

        .recommendation-box {
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .recommendation-box h4 {
            color: #1e40af;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .recommendation-item {
            background: white;
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            border: 2px solid #e0e7ff;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .recommendation-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .recommendation-item.selected {
            border-color: #667eea;
            background: #ede9fe;
        }

        .recommendation-item input[type="checkbox"] {
            margin-top: 2px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .recommendation-item label {
            cursor: pointer;
            flex: 1;
            color: #374151;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .content {
                padding: 25px;
            }

            .checkbox-group {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        .edit-btn {
            background: #f59e0b;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .edit-btn:hover {
            background: #d97706;
        }

        .quiz-container {
            background: #f9fafb;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }

        .quiz-question {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
        }

        .quiz-options {
            margin-top: 15px;
        }

        .quiz-option {
            background: #f9fafb;
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quiz-option:hover {
            background: #f3f4f6;
            border-color: #667eea;
        }

        .quiz-option.selected {
            background: #ede9fe;
            border-color: #667eea;
        }

        .quiz-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ í”„ë¡œì íŠ¸ ê¸°ë°˜ í•™ìŠµ ì‹œìŠ¤í…œ</h1>
            <p>2022 ê°œì • êµìœ¡ê³¼ì • ì—°ê³„ í”„ë¡œì íŠ¸</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="content" id="content">
            <!-- ë™ì  ì½˜í…ì¸  -->
        </div>
    </div>

    <script>
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwqfLj2RzOhQxTooAegbJmLEGDMnjbl6r1wQSdSrS6jJXxL8Z8PNqoW3NYmqFus9wVxOA/exec';
const API_ENDPOINT = GAS_WEB_APP_URL;  // ê°™ì€ URL ì‚¬ìš©

       
        let sessionData = {
            studentId: '',
            studentName: '',
            step: 0,
            grade: '',
            subjects: [],
            keyword: '',
            totalHours: 0,
            selectedTask: '',
            selectedTaskData: null,
            generatedTasks: null,  // ìƒì„±ëœ ê³¼ì œ ëª©ë¡ ìºì‹œ
            timeline: [],
            currentExecutionStep: undefined,
            executionData: [],
            reflection: '',
            reflectionDetails: {
                motivation: [],
                role: [],
                difficulties: [],
                learnings: [],
                regrets: [],
                future: []
            },
            selfEvaluation: {},
            quizPassed: false,
            reviewCompleted: false,
            startTime: null,
            lastSaved: null,
            isSubmitted: false
        };


// â­ AIì—ê²Œ í…ìŠ¤íŠ¸ ìƒì„±ì„ ìš”ì²­í•˜ëŠ” í•¨ìˆ˜
async function fetchAIGeneratedText(prompt) {
    // 1. í™”ë©´ì˜ ëª¨ë“  ë²„íŠ¼ì„ ì ì‹œ ëª» ëˆ„ë¥´ê²Œ ë°©ì–´ (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => btn.disabled = true);

    try {
        // 2. GAS ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡
        const response = await fetch(GAS_WEB_APP_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'ai_generate',
                prompt: prompt
            })
        });

        const result = await response.json();

        // 3. ê²°ê³¼ ë°˜í™˜
        if (result.success) {
            return result.data.text;
        } else {
            alert("AI í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + result.message);
            return null;
        }
    } catch (error) {
        console.error("ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬:", error);
        alert("ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return null;
    } finally {
        // 4. ì‘ì—…ì´ ëë‚˜ë©´ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
        buttons.forEach(btn => btn.disabled = false);
    }
}
        
        function saveToLocal() {
    try {
        // 1. ë§ˆì§€ë§‰ ì €ì¥ ì‹œê°„ ê¸°ë¡
        sessionData.lastSaved = new Date().toISOString();
        
        // 2. ë¸Œë¼ìš°ì € ë¡œì»¬ ì €ì¥ì†Œì— ë°ì´í„° ì €ì¥
        localStorage.setItem('projectData', JSON.stringify(sessionData));
        
        // 3. í™”ë©´ì— "ì €ì¥ë¨" í‘œì‹œ (í•¨ìˆ˜ ì´ë¦„ ì¼ì¹˜í™”)
        if (typeof showSaveStatus === 'function') {
            showSaveStatus(); 
        } else {
            console.log('ì„ì‹œ ì €ì¥ ì™„ë£Œ (í‘œì‹œ í•¨ìˆ˜ ì—†ìŒ)');
        }
    } catch (e) {
        console.error('âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', e);
    }
}

        function loadFromLocal() {
            const saved = localStorage.getItem('projectData');
            if (saved) {
                sessionData = JSON.parse(saved);
                return true;
            }
            return false;
        }

        function updateSaveStatus() {
            const statusDiv = document.getElementById('saveStatus');
            if (statusDiv) {
                const timeAgo = getTimeAgo(sessionData.lastSaved);
                statusDiv.innerHTML = `ğŸ’¾ ë§ˆì§€ë§‰ ì €ì¥: ${timeAgo}`;
            }
        }

        function getTimeAgo(isoString) {
            if (!isoString) return 'ì €ì¥ ì•ˆë¨';
            const diff = Date.now() - new Date(isoString).getTime();
            const minutes = Math.floor(diff / 60000);
            if (minutes < 1) return 'ë°©ê¸ˆ ì „';
            if (minutes < 60) return `${minutes}ë¶„ ì „`;
            return `${Math.floor(minutes / 60)}ì‹œê°„ ì „`;
        }
        

        setInterval(saveToLocal, 300000);

        let saveTimer;
        function autoSave() {
            clearTimeout(saveTimer);
            saveTimer = setTimeout(saveToLocal, 2000);
        }

        // ==========================================
        // â­ AI ê¸°ëŠ¥ ê³µí†µ í•¨ìˆ˜ (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ)
        // ==========================================
        
       async function callAI(prompt) {
  try {
    const response = await fetch(API_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        action: 'ai_generate',
        prompt: prompt
      })
    });

    const result = await response.json();

    if (!result.success) {
      throw new Error(result.message || 'AI ì„œë²„ ì˜¤ë¥˜');
    }

    return result.data.text;

  } catch (error) {
    console.error('AI í˜¸ì¶œ ì˜¤ë¥˜:', error);
    alert('AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
    return null;
  }
}

        
        function showAILoading(show, message = 'AIê°€ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...') {
            let loadingDiv = document.getElementById('aiLoadingOverlay');
            
            if (show) {
                if (!loadingDiv) {
                    loadingDiv = document.createElement('div');
                    loadingDiv.id = 'aiLoadingOverlay';
                    loadingDiv.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.7);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10000;
                    `;
                    loadingDiv.innerHTML = `
                        <div style="background: white; padding: 30px 50px; border-radius: 15px; text-align: center;">
                            <div style="font-size: 40px; margin-bottom: 15px;">ğŸ¤–</div>
                            <div style="font-size: 18px; color: #667eea; font-weight: bold;">${message}</div>
                            <div style="margin-top: 20px;">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(loadingDiv);
                } else {
                    loadingDiv.style.display = 'flex';
                }
            } else {
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function updateProgress() {
            let progress = 0;
            if (sessionData.currentExecutionStep !== undefined && sessionData.timeline.length > 0) {
                const executionProgress = (sessionData.currentExecutionStep / sessionData.timeline.length) * 11.11;
                progress = 44.44 + executionProgress;
            } else {
                progress = (sessionData.step / 8) * 100;
            }
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function renderStepNav() {
            const steps = ['í•™ìƒì •ë³´', 'ê¸°ë³¸ì„¤ì •', 'ê³¼ì œì„ íƒ', 'ì‹¤í–‰ê³„íš', 'ì‹¤í–‰', 'ì„±ì°°ì¼ì§€', 'ìê¸°í‰ê°€', 'í€´ì¦ˆ', 'ì™„ì„±'];
            let html = '<div class="nav-steps">';
            steps.forEach((name, index) => {
                let className = 'nav-step';
                if (index < sessionData.step) className += ' completed';
                if (index === sessionData.step) className += ' current';
                html += `<div class="${className}" onclick="goToStep(${index})">${index + 1}. ${name}</div>`;
            });
            html += '</div>';
            return html;
        }

        function goToStep(step) {
            if (step < sessionData.step || step === sessionData.step) {
                if (step === 4 && sessionData.currentExecutionStep !== undefined) {
                    renderExecutionStep(sessionData.currentExecutionStep);
                } else {
                    sessionData.step = step;
                    renderStep(step);
                }
            }
        }

        function renderStep(step) {
            updateProgress();
            const content = document.getElementById('content');
            let html = '';
            
            if (step > 0) {
                html += '<div class="save-status" id="saveStatus">ğŸ’¾ ë§ˆì§€ë§‰ ì €ì¥: í™•ì¸ ì¤‘...</div>';
                html += renderStepNav();
            }
            
            switch(step) {
                case 0: html += renderStudentInfo(); break;
                case 1: html += renderBasicSettings(); break;
                case 2: html += renderTaskSelection(); break;
                case 3: html += renderTimeline(); break;
                case 4: html += renderExecutionHub(); break;
                case 5: html += renderReflectionJournal(); break;
                case 6: html += renderSelfEvaluationPage(); break;
                case 7: html += ''; renderQuiz(); return;
                case 8: html += renderFinalReport(); break;
            }
            
            content.innerHTML = html;
            
            if (step > 0) updateSaveStatus();
            if (step === 1) updateCustomSubjectsList();
        }

        function renderStudentInfo() {
            return `
                <div class="step-indicator">í•™ìƒ ì •ë³´ ì…ë ¥</div>
                <div class="input-group">
                    <label>í•™ë²ˆ <span class="required">*</span></label>
                    <input type="text" class="input-field" id="studentId" placeholder="ì˜ˆ: 20101" value="${sessionData.studentId}">
                    <small style="color: #6b7280; display: block; margin-top: 8px;">ğŸ’¡ í•™ë²ˆë§Œìœ¼ë¡œ ì‹ë³„ë©ë‹ˆë‹¤</small>
                </div>
                <div class="input-group">
                    <label>ì´ë¦„ <span class="required">*</span></label>
                    <input type="text" class="input-field" id="studentName" placeholder="ì˜ˆ: í™ê¸¸ë™" value="${sessionData.studentName}">
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="submitStudentInfo()">ì‹œì‘í•˜ê¸°</button>
                </div>
            `;
        }

        function submitStudentInfo() {
            const id = document.getElementById('studentId').value.trim();
            const name = document.getElementById('studentName').value.trim();
            
            if (!id || !name) {
                alert('í•™ë²ˆê³¼ ì´ë¦„ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
                return;
            }
            
            sessionData.studentId = id;
            sessionData.studentName = name;
            sessionData.startTime = new Date().toISOString();
            sessionData.step = 1;
            
            saveToLocal();
            showToast('âœ… í•™ìƒ ì •ë³´ ì €ì¥ ì™„ë£Œ');
            renderStep(1);
        }

        function renderBasicSettings() {
            // ìë™ ë³µêµ¬: subjects ë°°ì—´ ê²€ì¦
            if (!sessionData.subjects || !Array.isArray(sessionData.subjects)) {
                console.warn('âš ï¸ subjects ë°°ì—´ ì˜¤ë¥˜ - ìë™ ì´ˆê¸°í™”');
                sessionData.subjects = [];
                saveToLocal();
            }
            
            const grades = ['ì¤‘1', 'ì¤‘2', 'ì¤‘3', 'ê³ 1', 'ê³ 2', 'ê³ 3'];
            const subjects = ['êµ­ì–´', 'ìˆ˜í•™', 'ì˜ì–´', 'ì‚¬íšŒ', 'ê³¼í•™', 'ì •ë³´', 'ê¸°ìˆ ê°€ì •', 'ìŒì•…', 'ë¯¸ìˆ ', 'ì²´ìœ¡', 'ì§„ë¡œ'];
            
            return `
                <div class="step-indicator">[1/8 ë‹¨ê³„] í”„ë¡œì íŠ¸ ê¸°ë³¸ ì„¤ì •</div>
                ${renderDataSummary()}
                <div class="input-group">
                    <label>í•™ë…„ ì„ íƒ <span class="required">*</span></label>
                    <select class="input-field" id="grade" onchange="autoSave()">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        ${grades.map(g => `<option value="${g}" ${sessionData.grade === g ? 'selected' : ''}>${g}</option>`).join('')}
                    </select>
                </div>
                <div class="input-group">
                    <label>ì—°ê³„ êµê³¼ (2ê°œ ì´ìƒ ì„ íƒ) <span class="required">*</span></label>
                    <div class="checkbox-group" id="subjectsGroup">
                        ${subjects.map(s => `
                            <div class="checkbox-item ${sessionData.subjects.includes(s) ? 'checked' : ''}" onclick="toggleSubject('${s}')">
                                <input type="checkbox" id="subject_${s}" ${sessionData.subjects.includes(s) ? 'checked' : ''}>
                                <label for="subject_${s}">${s}</label>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 2px dashed #3b82f6;">
                        <label style="display: block; margin-bottom: 8px; color: #1e40af; font-weight: 600;">âœï¸ ì§ì ‘ ì…ë ¥ (ìœ„ì— ì—†ëŠ” ê³¼ëª©)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" class="input-field" id="customSubject" placeholder="ì˜ˆ: ìƒí™œê³¼ìœ¤ë¦¬, ì„¸ê³„ì‚¬, í•œêµ­ì‚¬ ë“±" style="flex: 1;">
                            <button class="btn btn-primary" onclick="addCustomSubject()" style="padding: 12px 20px; white-space: nowrap;">ì¶”ê°€</button>
                        </div>
                        <div id="customSubjectsList" style="margin-top: 10px;"></div>
                    </div>
                </div>
                <div class="input-group">
                    <label>í•´ê²°ê³¼ì œ í‚¤ì›Œë“œ <span class="required">*</span></label>
                    <input type="text" class="input-field" id="keyword" placeholder="ê´€ì‹¬ ì£¼ì œë¥¼ ììœ ë¡­ê²Œ ì…ë ¥ (ì˜ˆ: í•™êµí­ë ¥, í™˜ê²½ì˜¤ì—¼, ì§„ë¡œê³ ë¯¼ ë“±)" value="${sessionData.keyword}" oninput="autoSave()">
                    <small style="color: #6b7280; display: block; margin-top: 8px;">ğŸ’¡ ì§€ì—­ì‚¬íšŒ ë¬¸ì œ, í•™êµ ë¬¸ì œ, ê°œì¸ ê³ ë¯¼ ë“± ë¬´ì—‡ì´ë“  ì¢‹ìŠµë‹ˆë‹¤</small>
                </div>
                <div class="input-group">
                    <label>ì‚¬ìš© ê°€ëŠ¥ ì‹œê°„ <span class="required">*</span></label>
                    <input type="number" class="input-field" id="totalHours" min="2" max="20" placeholder="ì‹œê°„ (ì˜ˆ: 4)" value="${sessionData.totalHours || ''}" oninput="autoSave()">
                    <small style="color: #6b7280; display: block; margin-top: 8px;">â° ê¶Œì¥: 4-8ì‹œê°„</small>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="goToStep(0)">ì´ì „</button>
                    <button class="btn btn-primary" onclick="submitBasicSettings()">ë‹¤ìŒ: AI ê³¼ì œ ì¶”ì²œë°›ê¸°</button>
                </div>
            `;
        }

        function toggleSubject(subject) {
            // ìë™ ë³µêµ¬: subjects ë°°ì—´ ê²€ì¦
            if (!sessionData.subjects || !Array.isArray(sessionData.subjects)) {
                console.warn('âš ï¸ subjects ë°°ì—´ ì˜¤ë¥˜ - ìë™ ì´ˆê¸°í™”');
                sessionData.subjects = [];
            }
            
            const index = sessionData.subjects.indexOf(subject);
            if (index > -1) {
                sessionData.subjects.splice(index, 1);
            } else {
                sessionData.subjects.push(subject);
            }
            
            console.log('êµê³¼ ì„ íƒë¨:', subject, '| ì „ì²´:', sessionData.subjects);
            
            const checkbox = document.getElementById(`subject_${subject}`);
            const item = checkbox.closest('.checkbox-item');
            
            if (checkbox.checked) {
                checkbox.checked = false;
                item.classList.remove('checked');
            } else {
                checkbox.checked = true;
                item.classList.add('checked');
            }
            
            updateCustomSubjectsList();
            autoSave();
        }

        function addCustomSubject() {
            const input = document.getElementById('customSubject');
            const subject = input.value.trim();
            
            if (!subject) {
                alert('ê³¼ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (sessionData.subjects.includes(subject)) {
                alert('ì´ë¯¸ ì„ íƒëœ ê³¼ëª©ì…ë‹ˆë‹¤.');
                input.value = '';
                return;
            }
            
            sessionData.subjects.push(subject);
            input.value = '';
            updateCustomSubjectsList();
            autoSave();
            showToast(`âœ… "${subject}" ì¶”ê°€ë¨`);
        }

        function updateCustomSubjectsList() {
            const listDiv = document.getElementById('customSubjectsList');
            if (!listDiv) return;
            
            const defaultSubjects = ['êµ­ì–´', 'ìˆ˜í•™', 'ì˜ì–´', 'ì‚¬íšŒ', 'ê³¼í•™', 'ì •ë³´', 'ê¸°ìˆ ê°€ì •', 'ìŒì•…', 'ë¯¸ìˆ ', 'ì²´ìœ¡', 'ì§„ë¡œ'];
            const customSubjects = sessionData.subjects.filter(s => !defaultSubjects.includes(s));
            
            if (customSubjects.length === 0) {
                listDiv.innerHTML = '';
                return;
            }
            
            listDiv.innerHTML = `
                <div style="margin-top: 10px;">
                    <strong style="color: #1e40af; font-size: 13px;">ì¶”ê°€ëœ ê³¼ëª©:</strong>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                        ${customSubjects.map(s => `
                            <span style="background: #dbeafe; color: #1e40af; padding: 6px 12px; border-radius: 6px; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                                ${s}
                                <button onclick="removeCustomSubject('${s}')" style="background: none; border: none; color: #1e40af; cursor: pointer; font-size: 16px; padding: 0; line-height: 1;">Ã—</button>
                            </span>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function removeCustomSubject(subject) {
            const index = sessionData.subjects.indexOf(subject);
            if (index > -1) {
                sessionData.subjects.splice(index, 1);
                updateCustomSubjectsList();
                autoSave();
                showToast(`âŒ "${subject}" ì‚­ì œë¨`);
            }
        }

        function submitBasicSettings() {
            const grade = document.getElementById('grade').value;
            const keyword = document.getElementById('keyword').value.trim();
            const hours = parseInt(document.getElementById('totalHours').value);
            
            console.log('=== submitBasicSettings ===');
            console.log('grade:', grade);
            console.log('subjects:', sessionData.subjects);
            console.log('keyword:', keyword);
            console.log('hours:', hours);
            
            if (!grade) {
                alert('í•™ë…„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ìë™ ë³µêµ¬: subjects ë°°ì—´ ê²€ì¦
            if (!sessionData.subjects || !Array.isArray(sessionData.subjects)) {
                console.warn('âš ï¸ subjects ë°°ì—´ ì˜¤ë¥˜ - ìë™ ì´ˆê¸°í™”');
                sessionData.subjects = [];
                saveToLocal();
            }
            
            if (sessionData.subjects.length < 2) {
                alert(`êµê³¼ë¥¼ 2ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.\n\ní˜„ì¬: ${sessionData.subjects.join(', ') || 'ì—†ìŒ'} (${sessionData.subjects.length}ê°œ)`);
                return;
            }
            
            if (!keyword) {
                alert('í•´ê²°ê³¼ì œ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!hours || hours < 2) {
                alert('ì‚¬ìš© ê°€ëŠ¥ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìµœì†Œ 2ì‹œê°„)');
                return;
            }
            
            sessionData.grade = grade;
            sessionData.keyword = keyword;
            sessionData.totalHours = hours;
            sessionData.step = 2;
            
            saveToLocal();
            showToast('âœ… ê¸°ë³¸ ì„¤ì • ì™„ë£Œ');
            renderStep(2);
        }

        function renderDataSummary() {
            if (sessionData.step <= 1) return '';
            let items = [];
            if (sessionData.studentId) items.push(`<div class="data-summary-item"><strong>í•™ë²ˆ:</strong> ${sessionData.studentId}</div>`);
            if (sessionData.studentName) items.push(`<div class="data-summary-item"><strong>ì´ë¦„:</strong> ${sessionData.studentName}</div>`);
            if (sessionData.grade) items.push(`<div class="data-summary-item"><strong>í•™ë…„:</strong> ${sessionData.grade}</div>`);
            if (sessionData.subjects.length > 0) items.push(`<div class="data-summary-item"><strong>êµê³¼:</strong> ${sessionData.subjects.join(', ')}</div>`);
            if (sessionData.keyword) items.push(`<div class="data-summary-item"><strong>í‚¤ì›Œë“œ:</strong> ${sessionData.keyword}</div>`);
            if (sessionData.totalHours) items.push(`<div class="data-summary-item"><strong>ì‹œê°„:</strong> ${sessionData.totalHours}ì‹œê°„</div>`);
            if (sessionData.selectedTask) items.push(`<div class="data-summary-item"><strong>ì„ íƒ ê³¼ì œ:</strong> ${sessionData.selectedTask}</div>`);
            if (items.length === 0) return '';
            return `<div class="data-summary"><h3>ğŸ“‹ í˜„ì¬ê¹Œì§€ ì„¤ì •í•œ ë‚´ìš©</h3>${items.join('')}${sessionData.step > 1 ? '<button class="edit-btn" onclick="goToStep(1)" style="margin-top: 10px;">âœï¸ ìˆ˜ì •í•˜ê¸°</button>' : ''}</div>`;
        }



// ==========================================
        // 2ë‹¨ê³„: ê³¼ì œ ì„ íƒ
        // ==========================================
        function renderTaskSelection() {
            const tasks = generateTaskRecommendations();
            
            return `
                <div class="step-indicator">[2/8 ë‹¨ê³„] AI ë§ì¶¤ ê³¼ì œ ì¶”ì²œ</div>
                ${renderDataSummary()}
                <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #3b82f6;">
                    <h3 style="color: #1e40af; margin-bottom: 10px;">ğŸ¤– AI ë¶„ì„ ê²°ê³¼</h3>
                    <p style="color: #1e3a8a; line-height: 1.6;">
                        <strong>${sessionData.grade}</strong> í•™ìƒì´ 
                        <strong>${sessionData.subjects.join(', ')}</strong> êµê³¼ì™€ ì—°ê³„í•˜ì—¬
                        <strong>"${sessionData.keyword}"</strong> ì£¼ì œë¡œ
                        <strong>${sessionData.totalHours}ì‹œê°„</strong> í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.
                    </p>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #374151;">âœ¨ ì¶”ì²œ í”„ë¡œì íŠ¸ ê³¼ì œ (5ê°œ)</h3>
                    <button class="btn btn-secondary" onclick="regenerateTasks()" style="padding: 10px 20px;">ğŸ”„ ë‹¤ì‹œ ì¶”ì²œë°›ê¸°</button>
                </div>
                <div id="taskCards">
                    ${tasks.map((task, index) => `
                        <div class="task-card ${sessionData.selectedTask === task.title ? 'selected' : ''}" onclick="selectTask(${index})">
                            <div class="task-card-header">
                                <div class="task-card-title">${index + 1}. ${task.title}</div>
                                <div class="task-card-badges">
                                    <span class="badge badge-difficulty-${task.difficulty === 'í•˜' ? 'low' : task.difficulty === 'ì¤‘' ? 'mid' : 'high'}">ë‚œì´ë„: ${task.difficulty}</span>
                                    <span class="badge badge-time">â° ${task.recommendedHours}ì‹œê°„</span>
                                </div>
                            </div>
                            <p style="color: #6b7280; font-size: 14px; line-height: 1.6; margin-top: 8px;">${task.description}</p>
                        </div>
                    `).join('')}
                </div>
                <div class="custom-input-section">
                    <h4>ğŸ’¡ ì§ì ‘ ê³¼ì œëª… ì…ë ¥í•˜ê¸°</h4>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" class="input-field" id="customTask" placeholder="ìœ„ ì¶”ì²œì´ ë§ˆìŒì— ì•ˆ ë“¤ë©´ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”" value="${sessionData.selectedTask && !tasks.find(t => t.title === sessionData.selectedTask) ? sessionData.selectedTask : ''}" style="flex: 1;">
                        <button class="btn btn-primary" onclick="selectCustomTask()" style="padding: 12px 24px; white-space: nowrap;">ì„ íƒ</button>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="goToStep(1)">ì´ì „</button>
                    <button class="btn btn-primary" onclick="submitTaskSelection()">ë‹¤ìŒ: ì‹¤í–‰ ê³„íš ìƒì„±</button>
                </div>
            `;
        }

        function generateTaskRecommendations() {
            // ì´ë¯¸ ìƒì„±ëœ ê³¼ì œê°€ ìˆìœ¼ë©´ ì¬ì‚¬ìš©
            if (sessionData.generatedTasks && sessionData.generatedTasks.length > 0) {
                return sessionData.generatedTasks;
            }
            
            const keyword = sessionData.keyword;
            const hours = sessionData.totalHours;
            
            const allTemplates = [
                {title: `${keyword} ë¬¸ì œ í•´ê²° ì¸í¬ê·¸ë˜í”½ ì œì‘`, description: `${keyword}ì˜ ì›ì¸ê³¼ í•´ê²°ì±…ì„ ì¡°ì‚¬í•˜ê³ , ì‹œê°ì ìœ¼ë¡œ í‘œí˜„í•œ ì¸í¬ê·¸ë˜í”½ì„ ì œì‘í•©ë‹ˆë‹¤.`, difficulty: hours <= 4 ? 'í•˜' : 'ì¤‘', recommendedHours: Math.min(hours, 4)},
                {title: `${keyword} ì‹¤íƒœ ì¡°ì‚¬ ë° ë°ì´í„° ë¶„ì„`, description: `ì„¤ë¬¸ì¡°ì‚¬ë‚˜ ì¸í„°ë·°ë¥¼ í†µí•´ ${keyword}ì˜ ì‹¤íƒœë¥¼ íŒŒì•…í•˜ê³ , ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ë³´ê³ ì„œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.`, difficulty: 'ì¤‘', recommendedHours: Math.min(hours, 6)},
                {title: `${keyword} í•´ê²° ìº í˜ì¸ ê¸°íš`, description: `${keyword} ë¬¸ì œë¥¼ ì•Œë¦¬ê³  í•´ê²°í•˜ê¸° ìœ„í•œ ìº í˜ì¸ì„ ê¸°íší•©ë‹ˆë‹¤. í¬ìŠ¤í„°, SNS ì»¨í…ì¸  ë“±ì„ ì œì‘í•©ë‹ˆë‹¤.`, difficulty: 'í•˜', recommendedHours: Math.min(hours, 5)},
                {title: `${keyword} ê´€ë ¨ ì•±/ì›¹ì‚¬ì´íŠ¸ í”„ë¡œí† íƒ€ì…`, description: `${keyword} ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë””ì§€í„¸ ì†”ë£¨ì…˜ì„ ê¸°íší•˜ê³ , ê°„ë‹¨í•œ í”„ë¡œí† íƒ€ì…ì„ ì œì‘í•©ë‹ˆë‹¤.`, difficulty: hours >= 6 ? 'ì¤‘' : 'ìƒ', recommendedHours: Math.max(hours, 6)},
                {title: `${keyword} ì •ì±… ì œì•ˆì„œ ì‘ì„±`, description: `${keyword} ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ êµ¬ì²´ì ì¸ ì •ì±…ì„ ì œì•ˆí•˜ê³ , ì‹¤í˜„ ê°€ëŠ¥ì„±ì„ ë¶„ì„í•œ ì œì•ˆì„œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.`, difficulty: 'ì¤‘', recommendedHours: Math.min(hours, 8)},
                {title: `${keyword} ë‹¤íë©˜í„°ë¦¬ ì˜ìƒ ì œì‘`, description: `${keyword}ì˜ í˜„í™©ê³¼ í•´ê²° í•„ìš”ì„±ì„ ë‹¤ë£¬ 3-5ë¶„ ë¶„ëŸ‰ì˜ ë‹¤íë©˜í„°ë¦¬ ì˜ìƒì„ ì œì‘í•©ë‹ˆë‹¤.`, difficulty: 'ì¤‘', recommendedHours: Math.min(hours, 6)},
                {title: `${keyword} í•´ê²°ì„ ìœ„í•œ êµìœ¡ í”„ë¡œê·¸ë¨ ê°œë°œ`, description: `${keyword}ì— ëŒ€í•œ ì¸ì‹ ê°œì„ ì„ ìœ„í•œ êµìœ¡ í”„ë¡œê·¸ë¨ê³¼ êµìœ¡ ìë£Œë¥¼ ê°œë°œí•©ë‹ˆë‹¤.`, difficulty: 'í•˜', recommendedHours: Math.min(hours, 5)},
                {title: `${keyword} ê´€ë ¨ ì¹´ë“œë‰´ìŠ¤ ì‹œë¦¬ì¦ˆ ì œì‘`, description: `SNSì—ì„œ ê³µìœ í•  ìˆ˜ ìˆëŠ” ${keyword} ê´€ë ¨ ì¹´ë“œë‰´ìŠ¤ 10ì¥ì„ ê¸°íší•˜ê³  ì œì‘í•©ë‹ˆë‹¤.`, difficulty: 'í•˜', recommendedHours: Math.min(hours, 4)},
                {title: `${keyword} ì²´í—˜í˜• ì „ì‹œ ê¸°íš`, description: `${keyword}ì„ ì§ì ‘ ì²´í—˜í•˜ê³  ì´í•´í•  ìˆ˜ ìˆëŠ” ì „ì‹œíšŒë¥¼ ê¸°íší•˜ê³  ì „ì‹œ íŒ¨ë„ì„ ì œì‘í•©ë‹ˆë‹¤.`, difficulty: 'ì¤‘', recommendedHours: Math.min(hours, 7)},
                {title: `${keyword} í•´ê²° ì•„ì´ë””ì–´ ì½˜í…ŒìŠ¤íŠ¸ ê°œìµœ`, description: `í•™êµë‚˜ ì§€ì—­ì‚¬íšŒì—ì„œ ${keyword} í•´ê²° ì•„ì´ë””ì–´ë¥¼ ëª¨ìœ¼ëŠ” ì½˜í…ŒìŠ¤íŠ¸ë¥¼ ê¸°íší•˜ê³  ìš´ì˜í•©ë‹ˆë‹¤.`, difficulty: 'ìƒ', recommendedHours: Math.max(hours, 8)},
                {title: `${keyword} ê´€ë ¨ íŒŸìºìŠ¤íŠ¸/ì˜¤ë””ì˜¤ë¶ ì œì‘`, description: `${keyword}ì— ëŒ€í•œ ì´ì•¼ê¸°ë¥¼ ë‹´ì€ íŒŸìºìŠ¤íŠ¸ë‚˜ ì˜¤ë””ì˜¤ë¶ì„ ê¸°íší•˜ê³  ë…¹ìŒí•©ë‹ˆë‹¤.`, difficulty: 'ì¤‘', recommendedHours: Math.min(hours, 6)},
                {title: `${keyword} ë¬¸ì œ í•´ê²° ë³´ë“œê²Œì„ ê°œë°œ`, description: `${keyword}ì„ ì¬ë¯¸ìˆê²Œ ë°°ìš°ê³  í•´ê²° ë°©ë²•ì„ ì°¾ì„ ìˆ˜ ìˆëŠ” ë³´ë“œê²Œì„ì„ ë””ìì¸í•©ë‹ˆë‹¤.`, difficulty: 'ìƒ', recommendedHours: Math.max(hours, 8)}
            ];
            
            const shuffled = allTemplates.sort(() => Math.random() - 0.5);
            const selected = shuffled.slice(0, 5);
            
            // ìƒì„±ëœ ê³¼ì œ ëª©ë¡ ì €ì¥
            sessionData.generatedTasks = selected;
            saveToLocal();
            
            return selected;
        }

        function regenerateTasks() {
            sessionData.selectedTask = '';
            sessionData.selectedTaskData = null;
            sessionData.generatedTasks = null;  // ìºì‹œ ì´ˆê¸°í™”
            showToast('ğŸ”„ ìƒˆë¡œìš´ ê³¼ì œë¥¼ ì¶”ì²œí•˜ê³  ìˆìŠµë‹ˆë‹¤...');
            setTimeout(() => {
                renderStep(2);
                showToast('âœ… ìƒˆë¡œìš´ ì¶”ì²œì´ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }, 500);
        }

        function selectTask(index) {
            const tasks = generateTaskRecommendations();
            sessionData.selectedTask = tasks[index].title;
            sessionData.selectedTaskData = tasks[index];
            
            console.log('âœ… ê³¼ì œ ì„ íƒë¨:', tasks[index].title);
            console.log('ì„ íƒëœ ê³¼ì œ ë°ì´í„°:', sessionData.selectedTaskData);
            
            // ì¹´ë“œ ì„ íƒ í‘œì‹œ
            document.querySelectorAll('.task-card').forEach((card, i) => {
                if (i === index) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
            
            // ì§ì ‘ ì…ë ¥ë€ ì´ˆê¸°í™”
            const customTaskInput = document.getElementById('customTask');
            if (customTaskInput) {
                customTaskInput.value = '';
            }
            
            // ìƒë‹¨ ìš”ì•½ ì •ë³´ë§Œ ì—…ë°ì´íŠ¸
            updateDataSummary();
            
            autoSave();
            showToast(`âœ… "${tasks[index].title}" ì„ íƒë¨`);
        }

        function selectCustomTask() {
            const customTask = document.getElementById('customTask').value.trim();
            
            if (!customTask) {
                alert('ê³¼ì œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            sessionData.selectedTask = customTask;
            sessionData.selectedTaskData = {
                title: customTask,
                description: 'í•™ìƒì´ ì§ì ‘ ì…ë ¥í•œ ê³¼ì œì…ë‹ˆë‹¤.',
                difficulty: 'ì¤‘',
                recommendedHours: sessionData.totalHours
            };
            
            // ëª¨ë“  ì¹´ë“œ ì„ íƒ í•´ì œ
            document.querySelectorAll('.task-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // ìƒë‹¨ ìš”ì•½ ì •ë³´ë§Œ ì—…ë°ì´íŠ¸
            updateDataSummary();
            
            autoSave();
            showToast(`âœ… "${customTask}" ì„ íƒë¨`);
        }
        
        function updateDataSummary() {
            const summaryDiv = document.querySelector('.data-summary');
            if (summaryDiv) {
                let items = [];
                if (sessionData.studentId) items.push(`<div class="data-summary-item"><strong>í•™ë²ˆ:</strong> ${sessionData.studentId}</div>`);
                if (sessionData.studentName) items.push(`<div class="data-summary-item"><strong>ì´ë¦„:</strong> ${sessionData.studentName}</div>`);
                if (sessionData.grade) items.push(`<div class="data-summary-item"><strong>í•™ë…„:</strong> ${sessionData.grade}</div>`);
                if (sessionData.subjects.length > 0) items.push(`<div class="data-summary-item"><strong>êµê³¼:</strong> ${sessionData.subjects.join(', ')}</div>`);
                if (sessionData.keyword) items.push(`<div class="data-summary-item"><strong>í‚¤ì›Œë“œ:</strong> ${sessionData.keyword}</div>`);
                if (sessionData.totalHours) items.push(`<div class="data-summary-item"><strong>ì‹œê°„:</strong> ${sessionData.totalHours}ì‹œê°„</div>`);
                if (sessionData.selectedTask) items.push(`<div class="data-summary-item"><strong>ì„ íƒ ê³¼ì œ:</strong> ${sessionData.selectedTask}</div>`);
                
                summaryDiv.innerHTML = items.join('');
            }
        }

        function submitTaskSelection() {
            if (!sessionData.selectedTask) {
                alert('ê³¼ì œë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            sessionData.step = 3;
            saveToLocal();
            showToast('âœ… ê³¼ì œ ì„ íƒ ì™„ë£Œ');
            renderStep(3);
        }

        // ==========================================
        // 3ë‹¨ê³„: ì‹¤í–‰ ê³„íš
        // ==========================================
        function renderTimeline() {
            const timeline = generateTimeline();
            sessionData.timeline = timeline;
            
            return `
                <div class="step-indicator">[3/8 ë‹¨ê³„] ì‹¤í–‰ ê³„íš ìë™ ìƒì„±</div>
                ${renderDataSummary()}
                <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #10b981;">
                    <h3 style="color: #15803d; margin-bottom: 10px;">ğŸ¯ ì„ íƒí•œ ê³¼ì œ</h3>
                    <p style="font-size: 18px; font-weight: 600; color: #166534; margin-bottom: 8px;">${sessionData.selectedTask}</p>
                    <p style="color: #166534;">${sessionData.selectedTaskData.description}</p>
                </div>
                
                ${renderDesignRecommendations()}
                
                <h3 style="margin-bottom: 20px; color: #374151;">â° ${sessionData.totalHours}ì‹œê°„ ì‹¤í–‰ ê³„íš</h3>
                <div class="timeline">
                    ${timeline.map((item, index) => `
                        <div class="timeline-item">
                            <div class="timeline-header">
                                <div class="timeline-title">ğŸ“ ${index + 1}ì‹œê°„ì°¨: ${item.title}</div>
                                <div class="timeline-time">â±ï¸ ${item.duration}ë¶„</div>
                            </div>
                            <p style="color: #6b7280; margin-bottom: 12px;">${item.mission}</p>
                            <ul class="timeline-activities">
                                ${item.activities.map(act => `<li>${act}</li>`).join('')}
                            </ul>
                            <details class="hint-section">
                                <summary>ğŸ’¡ AI íŒíŠ¸ ë³´ê¸° (${item.hints.length}ê°œ)</summary>
                                <ul class="hint-list">
                                    ${item.hints.map(hint => `<li>${hint}</li>`).join('')}
                                </ul>
                            </details>
                        </div>
                    `).join('')}
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="goToStep(2)">ì´ì „</button>
                    <button class="btn btn-primary" onclick="goToExecution()">ë‹¤ìŒ: í”„ë¡œì íŠ¸ ì‹¤í–‰</button>
                </div>
            `;
        }

        function renderDesignRecommendations() {
            const taskType = sessionData.selectedTask;
            let recommendations = [];
            
            if (taskType.includes('ì¸í¬ê·¸ë˜í”½') || taskType.includes('í¬ìŠ¤í„°') || taskType.includes('ì¹´ë“œë‰´ìŠ¤')) {
                recommendations = [
                    { tool: 'Canva', url: 'https://www.canva.com', desc: 'ë¬´ë£Œ ë””ìì¸ ë„êµ¬, í…œí”Œë¦¿ í’ë¶€' },
                    { tool: 'ë¯¸ë¦¬ìº”ë²„ìŠ¤', url: 'https://www.miricanvas.com', desc: 'í•œê¸€ ì§€ì›, ë‹¤ì–‘í•œ í…œí”Œë¦¿' },
                    { tool: 'Figma', url: 'https://www.figma.com', desc: 'ì „ë¬¸ê°€ìš©, í˜‘ì—… ê¸°ëŠ¥' }
                ];
            } else if (taskType.includes('ì˜ìƒ') || taskType.includes('ë‹¤í')) {
                recommendations = [
                    { tool: 'CapCut', url: 'https://www.capcut.com', desc: 'ë¬´ë£Œ ì˜ìƒ í¸ì§‘, ì‰¬ìš´ ì‚¬ìš©' },
                    { tool: 'Clipchamp', url: 'https://clipchamp.com', desc: 'ì˜¨ë¼ì¸ í¸ì§‘, ìœˆë„ìš° ê¸°ë³¸' },
                    { tool: 'DaVinci Resolve', url: 'https://www.blackmagicdesign.com/kr/products/davinciresolve', desc: 'ë¬´ë£Œ ì „ë¬¸ê°€ìš©' }
                ];
            } else if (taskType.includes('ì•±') || taskType.includes('ì›¹ì‚¬ì´íŠ¸') || taskType.includes('í”„ë¡œí† íƒ€ì…')) {
                recommendations = [
                    { tool: 'Figma', url: 'https://www.figma.com', desc: 'UI/UX ë””ìì¸ ë° í”„ë¡œí† íƒ€ì…' },
                    { tool: 'Adobe XD', url: 'https://www.adobe.com/kr/products/xd.html', desc: 'í”„ë¡œí† íƒ€ì… ì œì‘' },
                    { tool: 'Mockitt', url: 'https://mockitt.wondershare.com', desc: 'ë¬´ë£Œ í”„ë¡œí† íƒ€ì… ë„êµ¬' }
                ];
            } else {
                recommendations = [
                    { tool: 'Canva', url: 'https://www.canva.com', desc: 'ë¬¸ì„œ, í”„ë ˆì  í…Œì´ì…˜ ì œì‘' },
                    { tool: 'Google Slides', url: 'https://slides.google.com', desc: 'ì˜¨ë¼ì¸ í”„ë ˆì  í…Œì´ì…˜' },
                    { tool: 'Notion', url: 'https://www.notion.so', desc: 'ë¬¸ì„œ ì •ë¦¬ ë° í˜‘ì—…' }
                ];
            }
            
            if (recommendations.length === 0) return '';
            
            return `
                <div class="recommendation-box">
                    <h4>ğŸ¨ ì¶”ì²œ ë„êµ¬ ë° í…œí”Œë¦¿</h4>
                    <p style="color: #1e3a8a; margin-bottom: 15px; font-size: 14px;">
                        ê²°ê³¼ë¬¼ ì œì‘ì— ë„ì›€ì´ ë˜ëŠ” ë„êµ¬ë“¤ì…ë‹ˆë‹¤. í´ë¦­í•˜ë©´ í•´ë‹¹ ì‚¬ì´íŠ¸ë¡œ ì´ë™í•©ë‹ˆë‹¤.
                    </p>
                    <div style="display: grid; gap: 10px;">
                        ${recommendations.map(rec => `
                            <a href="${rec.url}" target="_blank" style="text-decoration: none;">
                                <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #e0e7ff; transition: all 0.3s; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; color: #1e40af; margin-bottom: 4px;">ğŸ”— ${rec.tool}</div>
                                        <div style="font-size: 13px; color: #6b7280;">${rec.desc}</div>
                                    </div>
                                    <div style="color: #667eea;">â†’</div>
                                </div>
                            </a>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function generateTimeline() {
            const hours = sessionData.totalHours;
            const timeline = [];
            const stepsCount = Math.min(hours, 10);  // ìµœëŒ€ 10ì°¨ì‹œ
            
            const taskTitle = sessionData.selectedTaskData.title || sessionData.selectedTask;
            const isInfographic = taskTitle.includes('ì¸í¬ê·¸ë˜í”½');
            const isVideo = taskTitle.includes('ì˜ìƒ') || taskTitle.includes('ë‹¤í');
            const isPoster = taskTitle.includes('í¬ìŠ¤í„°') || taskTitle.includes('ìº í˜ì¸');
            const isReport = taskTitle.includes('ë³´ê³ ì„œ') || taskTitle.includes('ì œì•ˆì„œ') || taskTitle.includes('ì¡°ì‚¬');
            const isApp = taskTitle.includes('ì•±') || taskTitle.includes('ì›¹ì‚¬ì´íŠ¸') || taskTitle.includes('í”„ë¡œí† íƒ€ì…');
            
            // ì°¨ì‹œë³„ í…œí”Œë¦¿
            const templates = [
                {title: 'ë¬¸ì œ íŒŒì•… ë° ì¡°ì‚¬', duration: 60, mission: 'ë¬¸ì œì˜ ì›ì¸ê³¼ í˜„í™©ì„ ì¡°ì‚¬í•©ë‹ˆë‹¤', activities: ['ë¬¸ì œ ìƒí™© ìë£Œ ì¡°ì‚¬ (20ë¶„)', 'ê´€ë ¨ ë°ì´í„°/ì‚¬ë¡€ ìˆ˜ì§‘ (20ë¶„)', 'ì¡°ì‚¬ ë‚´ìš© ì •ë¦¬ (20ë¶„)'], hints: ['ì¸í„°ë„· ê²€ìƒ‰ìœ¼ë¡œ ìµœì‹  ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ì°¾ì•„ë³´ì„¸ìš”', 'í†µê³„ì²­ì´ë‚˜ ê³µê³µë°ì´í„° í¬í„¸ì—ì„œ ê´€ë ¨ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'ì£¼ë³€ ì‚¬ëŒë“¤ì˜ ì˜ê²¬ì„ ê°„ë‹¨íˆ ë¬¼ì–´ë³´ëŠ” ê²ƒë„ ì¢‹ìŠµë‹ˆë‹¤']},
                {title: 'í•´ê²° ë°©ì•ˆ êµ¬ìƒ', duration: 60, mission: 'ë¬¸ì œë¥¼ í•´ê²°í•  ë°©ë²•ì„ ìƒê°í•©ë‹ˆë‹¤', activities: ['ì•„ì´ë””ì–´ ë¸Œë ˆì¸ìŠ¤í† ë° (15ë¶„)', 'ì‹¤í˜„ ê°€ëŠ¥í•œ ë°©ì•ˆ 3ê°œ ì„ ì • (20ë¶„)', 'ê° ë°©ì•ˆì˜ ì¥ë‹¨ì  ë¶„ì„ (25ë¶„)'], hints: ['ë„ˆë¬´ ê±°ì°½í•œ í•´ê²°ì±…ë³´ë‹¤ ì‘ì§€ë§Œ ì‹¤ì²œ ê°€ëŠ¥í•œ ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤', 'ë‹¤ë¥¸ ì§€ì—­ì´ë‚˜ í•™êµì˜ ì„±ê³µ ì‚¬ë¡€ë¥¼ ì°¸ê³ í•˜ì„¸ìš”', 'ì—¬ëŸ¬ ê´€ì ì—ì„œ ìƒê°í•´ë³´ì„¸ìš”: ê°œì¸/í•™êµ/ì§€ì—­ì‚¬íšŒ']},
                {title: 'ì‚°ì¶œë¬¼ ê¸°íš ë° ì„¤ê³„', duration: 60, mission: 'ë§Œë“¤ ê²°ê³¼ë¬¼ì„ êµ¬ì²´ì ìœ¼ë¡œ ê³„íší•©ë‹ˆë‹¤', activities: ['ê²°ê³¼ë¬¼ êµ¬ì¡° ë° ëª©ì°¨ ì‘ì„± (20ë¶„)', 'í•„ìš”í•œ ìë£Œ ë° ë„êµ¬ ì¤€ë¹„ (20ë¶„)', 'ì„¸ë¶€ ì¼ì • ë° ì—­í•  ê³„íš (20ë¶„)'], hints: isInfographic ? ['ì–´ë–¤ ì •ë³´ë¥¼ ì–´ë–¤ ìˆœì„œë¡œ ë³´ì—¬ì¤„ì§€ ìŠ¤ì¼€ì¹˜í•´ë³´ì„¸ìš”', 'ìƒ‰ìƒ í…Œë§ˆì™€ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ì„ ë¯¸ë¦¬ ì •í•˜ì„¸ìš”'] : isVideo ? ['ì˜ìƒ êµ¬ì„±ì•ˆ(ìŠ¤í† ë¦¬ë³´ë“œ)ì„ ê°„ë‹¨íˆ ê·¸ë ¤ë³´ì„¸ìš”', 'ì´¬ì˜ ì¥ì†Œì™€ í•„ìš”í•œ ì¥ë¹„ë¥¼ í™•ì¸í•˜ì„¸ìš”'] : ['ëª©ì°¨ë¥¼ ë¨¼ì € ì‘ì„±í•˜ê³  ê° ë¶€ë¶„ì˜ ë¶„ëŸ‰ì„ ì •í•˜ì„¸ìš”', 'í•„ìš”í•œ ì´ë¯¸ì§€ë‚˜ ìë£Œë¥¼ ë¯¸ë¦¬ ì¤€ë¹„í•˜ì„¸ìš”']},
                {title: 'ì´ˆì•ˆ ì‘ì„± (1ì°¨)', duration: 60, mission: 'ê²°ê³¼ë¬¼ì˜ ê¸°ë³¸ í‹€ì„ ë§Œë“­ë‹ˆë‹¤', activities: ['í•µì‹¬ ë‚´ìš© ì‘ì„± (30ë¶„)', 'ìë£Œ ë°°ì¹˜ ë° êµ¬ì„± (20ë¶„)', '1ì°¨ ê²€í†  (10ë¶„)'], hints: ['ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ê´œì°®ìŠµë‹ˆë‹¤. ì¼ë‹¨ ë§Œë“¤ì–´ë³´ì„¸ìš”', 'í…œí”Œë¦¿ì„ í™œìš©í•˜ë©´ ì‹œê°„ì„ ì ˆì•½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'ì¤‘ìš”í•œ ë©”ì‹œì§€ê°€ ëª…í™•íˆ ì „ë‹¬ë˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”']},
                {title: 'ë³¸ê²© ì œì‘ (2ì°¨)', duration: 60, mission: 'ê²°ê³¼ë¬¼ì„ êµ¬ì²´ì ìœ¼ë¡œ ë‹¤ë“¬ìŠµë‹ˆë‹¤', activities: ['ì„¸ë¶€ ë‚´ìš© ë³´ì™„ (25ë¶„)', 'ë””ìì¸ ë° í¸ì§‘ ì‘ì—… (25ë¶„)', '2ì°¨ ê²€í†  (10ë¶„)'], hints: isInfographic || isPoster ? ['Canva, ë¯¸ë¦¬ìº”ë²„ìŠ¤ ê°™ì€ ë¬´ë£Œ ë””ìì¸ ë„êµ¬ë¥¼ í™œìš©í•˜ì„¸ìš”', 'ìƒ‰ìƒê³¼ ê¸€ê¼´ì€ 2-3ê°€ì§€ë¡œ í†µì¼í•˜ëŠ” ê²ƒì´ ë³´ê¸° ì¢‹ìŠµë‹ˆë‹¤'] : isVideo ? ['ì˜ìƒ í¸ì§‘ ì‹œ ìë§‰ê³¼ ë°°ê²½ìŒì•…ì„ ìŠì§€ ë§ˆì„¸ìš”', 'ì˜ìƒ ê¸¸ì´ëŠ” 3-5ë¶„ ë‚´ì™¸ê°€ ì ë‹¹í•©ë‹ˆë‹¤'] : ['ë¬¸ë‹¨ êµ¬ë¶„ì„ ëª…í™•íˆ í•˜ê³  ì½ê¸° ì‰½ê²Œ ì‘ì„±í•˜ì„¸ìš”', 'í‘œì™€ ê·¸ë˜í”„ë¥¼ í™œìš©í•˜ë©´ ì´í•´í•˜ê¸° ì‰½ìŠµë‹ˆë‹¤']},
                {title: 'ë³´ì™„ ë° ê°œì„ ', duration: 60, mission: 'ë¶€ì¡±í•œ ë¶€ë¶„ì„ ì°¾ì•„ ê°œì„ í•©ë‹ˆë‹¤', activities: ['í”¼ë“œë°± ìˆ˜ì§‘ (15ë¶„)', 'ìˆ˜ì • ì‚¬í•­ ë°˜ì˜ (30ë¶„)', '3ì°¨ ê²€í†  (15ë¶„)'], hints: ['ì¹œêµ¬ë‚˜ ì„ ìƒë‹˜ê»˜ ë³´ì—¬ë“œë¦¬ê³  ì˜ê²¬ì„ ë“¤ì–´ë³´ì„¸ìš”', 'ê°ê´€ì ì¸ ì‹œê°ì—ì„œ ë‹¤ì‹œ í•œë²ˆ ì‚´í´ë³´ì„¸ìš”', 'ë§ì¶¤ë²•ê³¼ ì˜¤íƒˆìë¥¼ ê¼¼ê¼¼íˆ í™•ì¸í•˜ì„¸ìš”']},
                {title: 'ìµœì¢… ì™„ì„±', duration: 60, mission: 'ê²°ê³¼ë¬¼ì„ ì™„ë²½í•˜ê²Œ ë§ˆë¬´ë¦¬í•©ë‹ˆë‹¤', activities: ['ìµœì¢… ìˆ˜ì • ë° ë³´ì™„ (30ë¶„)', 'í’ˆì§ˆ ìµœì¢… í™•ì¸ (20ë¶„)', 'íŒŒì¼ ì €ì¥ ë° ë°±ì—… (10ë¶„)'], hints: ['ëª¨ë“  ë‚´ìš©ì´ ì •í™•í•˜ê³  ì¼ê´€ì„± ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”', 'íŒŒì¼ëª…ì„ ëª…í™•í•˜ê²Œ ì €ì¥í•˜ì„¸ìš” (ì˜ˆ: í•™ë…„_ì´ë¦„_ê³¼ì œëª…)', 'ì—¬ëŸ¬ ë²„ì „ìœ¼ë¡œ ì €ì¥í•´ë‘ë©´ ì•ˆì „í•©ë‹ˆë‹¤']},
                {title: 'ë°œí‘œ ìë£Œ ì¤€ë¹„', duration: 60, mission: 'í”„ë¡œì íŠ¸ ê²°ê³¼ë¥¼ ë°œí‘œí•  ì¤€ë¹„ë¥¼ í•©ë‹ˆë‹¤', activities: ['ë°œí‘œ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± (25ë¶„)', 'ë°œí‘œ ìë£Œ ì •ë¦¬ (25ë¶„)', 'ë°œí‘œ ì—°ìŠµ (10ë¶„)'], hints: ['3-5ë¶„ ì •ë„ë¡œ í•µì‹¬ë§Œ ê°„ê²°í•˜ê²Œ ì¤€ë¹„í•˜ì„¸ìš”', 'Q&Aì— ëŒ€ë¹„í•´ ì˜ˆìƒ ì§ˆë¬¸ì„ ìƒê°í•´ë³´ì„¸ìš”', 'ì‹œì—°ì´ í•„ìš”í•˜ë©´ ë¯¸ë¦¬ ì¤€ë¹„í•˜ì„¸ìš”']},
                {title: 'í”„ë¡œì íŠ¸ ë§ˆë¬´ë¦¬', duration: 60, mission: 'í”„ë¡œì íŠ¸ë¥¼ ëŒì•„ë³´ê³  ì •ë¦¬í•©ë‹ˆë‹¤', activities: ['í”„ë¡œì íŠ¸ ê³¼ì • ì •ë¦¬ (20ë¶„)', 'ë°°ìš´ ì  ì •ë¦¬ (20ë¶„)', 'ì•„ì‰¬ìš´ ì  ë° ê°œì„  ë°©í–¥ (20ë¶„)'], hints: ['ì–´ë–¤ ì ì´ ê°€ì¥ ì–´ë ¤ì› ê³ , ì–´ë–»ê²Œ í•´ê²°í–ˆë‚˜ìš”?', 'ì´ ê²½í—˜ì„ í†µí•´ ë¬´ì—‡ì„ ë°°ì› ë‚˜ìš”?', 'ë‹¤ìŒì— ë¹„ìŠ·í•œ í”„ë¡œì íŠ¸ë¥¼ í•œë‹¤ë©´ ë¬´ì—‡ì„ ë°”ê¾¸ê³  ì‹¶ë‚˜ìš”?']},
                {title: 'ìµœì¢… ì ê²€ ë° ì œì¶œ', duration: 60, mission: 'ëª¨ë“  ê²ƒì„ ìµœì¢… í™•ì¸í•˜ê³  ì œì¶œí•©ë‹ˆë‹¤', activities: ['ì œì¶œ ìš”êµ¬ì‚¬í•­ í™•ì¸ (15ë¶„)', 'ìµœì¢… ì ê²€ (30ë¶„)', 'ì œì¶œ ë° ë°±ì—… (15ë¶„)'], hints: ['ì œì¶œ ê¸°í•œê³¼ ë°©ë²•ì„ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•˜ì„¸ìš”', 'ëª¨ë“  íŒŒì¼ì´ ì œëŒ€ë¡œ ì €ì¥ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”', 'ì œì¶œ í›„ì—ë„ íŒŒì¼ì„ ë³´ê´€í•´ë‘ì„¸ìš”']}
            ];
            
            // ì°¨ì‹œ ìˆ˜ì— ë”°ë¼ ì ì ˆí•œ ë‹¨ê³„ ì„ íƒ
            if (stepsCount === 2) {
                // 2ì°¨ì‹œ: ì¡°ì‚¬ â†’ ì™„ì„±
                timeline.push(templates[0], templates[6]);
            } else if (stepsCount === 3) {
                // 3ì°¨ì‹œ: ì¡°ì‚¬ â†’ ì œì‘ â†’ ì™„ì„±
                timeline.push(templates[0], templates[4], templates[6]);
            } else if (stepsCount === 4) {
                // 4ì°¨ì‹œ: ì¡°ì‚¬ â†’ êµ¬ìƒ â†’ ì œì‘ â†’ ì™„ì„±
                timeline.push(templates[0], templates[1], templates[4], templates[6]);
            } else if (stepsCount === 5) {
                // 5ì°¨ì‹œ: ì¡°ì‚¬ â†’ êµ¬ìƒ â†’ ê¸°íš â†’ ì œì‘ â†’ ì™„ì„±
                timeline.push(templates[0], templates[1], templates[2], templates[4], templates[6]);
            } else if (stepsCount === 6) {
                // 6ì°¨ì‹œ: ì¡°ì‚¬ â†’ êµ¬ìƒ â†’ ê¸°íš â†’ ì´ˆì•ˆ â†’ ì œì‘ â†’ ì™„ì„±
                timeline.push(templates[0], templates[1], templates[2], templates[3], templates[4], templates[6]);
            } else if (stepsCount === 7) {
                // 7ì°¨ì‹œ: ì¡°ì‚¬ â†’ êµ¬ìƒ â†’ ê¸°íš â†’ ì´ˆì•ˆ â†’ ì œì‘ â†’ ë³´ì™„ â†’ ì™„ì„±
                timeline.push(templates[0], templates[1], templates[2], templates[3], templates[4], templates[5], templates[6]);
            } else if (stepsCount === 8) {
                // 8ì°¨ì‹œ: ì¡°ì‚¬ â†’ êµ¬ìƒ â†’ ê¸°íš â†’ ì´ˆì•ˆ â†’ ì œì‘ â†’ ë³´ì™„ â†’ ì™„ì„± â†’ ë°œí‘œì¤€ë¹„
                timeline.push(templates[0], templates[1], templates[2], templates[3], templates[4], templates[5], templates[6], templates[7]);
            } else if (stepsCount === 9) {
                // 9ì°¨ì‹œ: ì¡°ì‚¬ â†’ êµ¬ìƒ â†’ ê¸°íš â†’ ì´ˆì•ˆ â†’ ì œì‘ â†’ ë³´ì™„ â†’ ì™„ì„± â†’ ë°œí‘œì¤€ë¹„ â†’ í”„ë¡œì íŠ¸ë§ˆë¬´ë¦¬
                timeline.push(templates[0], templates[1], templates[2], templates[3], templates[4], templates[5], templates[6], templates[7], templates[8]);
            } else {
                // 10ì°¨ì‹œ: ì „ì²´
                timeline.push(...templates);
            }
            
            return timeline;
        }

       function goToExecution() {
    sessionData.step = 4;
    // ì¤‘ìš”: executionData ì´ˆê¸°í™” í™•ì¸
    if (!sessionData.executionData) {
        sessionData.executionData = undefined;
    }
    if (sessionData.currentExecutionStep === undefined) {
        sessionData.currentExecutionStep = undefined;
    }
    saveToLocal();
    showToast('âœ… ì‹¤í–‰ ê³„íš ì™„ë£Œ');
    renderStep(4);
}


        // ==========================================
        // 4ë‹¨ê³„: ì‹¤í–‰ í—ˆë¸Œ
        // ==========================================
        
function renderExecutionHub() {
    // ë””ë²„ê¹…ìš© ì½˜ì†”
    console.log('=== renderExecutionHub DEBUG ===');
    console.log('currentExecutionStep:', sessionData.currentExecutionStep);
    console.log('executionData:', sessionData.executionData);
    console.log('timeline length:', sessionData.timeline ? sessionData.timeline.length : 0);
    
    const totalSteps = sessionData.timeline ? sessionData.timeline.length : 0;
    const completedSteps = sessionData.executionData && Array.isArray(sessionData.executionData) 
        ? sessionData.executionData.filter(e => e && e.content).length 
        : 0;
    
    const hasStarted = typeof sessionData.currentExecutionStep === 'number';
    const allCompleted = totalSteps > 0 && completedSteps > 0 && completedSteps === totalSteps;
    
    console.log('hasStarted:', hasStarted);
    console.log('allCompleted:', allCompleted);
    console.log('completedSteps:', completedSteps, '/', totalSteps);
    console.log('================================');
    
    return `
        <div class="step-indicator">[4/8 ë‹¨ê³„] í”„ë¡œì íŠ¸ ì‹¤í–‰</div>
        ${renderDataSummary()}
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; text-align: center;">
            <h2 style="margin-bottom: 15px;">ğŸš€ í”„ë¡œì íŠ¸ ì‹¤í–‰í•˜ê¸°</h2>
            <p style="opacity: 0.95; line-height: 1.6;">
                ${hasStarted ? 'ì‘ì„± ì¤‘ì¸ í”„ë¡œì íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤.<br>ì´ì–´ì„œ ì‘ì„±í•˜ê±°ë‚˜ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' : 'ê³„íší•œ ëŒ€ë¡œ í”„ë¡œì íŠ¸ë¥¼ ì‹¤í–‰í•´ë´…ì‹œë‹¤!<br>ê° ì°¨ì‹œë³„ë¡œ í™œë™ì„ ê¸°ë¡í•˜ë©´ì„œ ì§„í–‰í•©ë‹ˆë‹¤.'}
            </p>
        </div>
        
        ${hasStarted && !allCompleted ? `
            <div style="background: #fef3c7; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #f59e0b;">
                <h3 style="color: #b45309; margin-bottom: 10px;">ğŸ“Š í˜„ì¬ ì§„í–‰ ìƒí™©</h3>
                <p style="color: #78350f; font-size: 16px; font-weight: 600;">
                    ${completedSteps}/${totalSteps} ì°¨ì‹œ ì™„ë£Œ
                </p>
                <div style="background: rgba(255,255,255,0.5); height: 12px; border-radius: 6px; margin-top: 15px; overflow: hidden;">
                    <div style="background: #10b981; height: 100%; width: ${totalSteps > 0 ? (completedSteps / totalSteps) * 100 : 0}%; transition: width 0.5s;"></div>
                </div>
            </div>
        ` : ''}
        
        ${allCompleted ? `
            <div style="background: #dcfce7; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #10b981;">
                <h3 style="color: #15803d; margin-bottom: 10px;">ğŸ‰ ëª¨ë“  ì°¨ì‹œ ì™„ë£Œ!</h3>
                <p style="color: #166534; font-size: 16px; font-weight: 600;">
                    ${completedSteps}/${totalSteps} ì°¨ì‹œ ì™„ë£Œ
                </p>
                <p style="color: #166534; margin-top: 10px;">
                    ì´ì œ ì„±ì°°ì¼ì§€ë¥¼ ì‘ì„±í•  ì°¨ë¡€ì…ë‹ˆë‹¤.
                </p>
            </div>
        ` : ''}
        
        <div class="btn-group" style="justify-content: center;">
            ${allCompleted ? `
                <button class="btn btn-success" onclick="goToStep(5)" style="flex: 1; max-width: 300px;">
                    ë‹¤ìŒ: ì„±ì°°ì¼ì§€ ì‘ì„± â–¶
                </button>
            ` : hasStarted ? `
                <button class="btn btn-primary" onclick="continueExecution()" style="flex: 1; max-width: 300px;">
                    â–¶ ì´ì–´ì„œ ì‘ì„±í•˜ê¸° (${sessionData.currentExecutionStep + 1}ì°¨ì‹œë¶€í„°)
                </button>
                <button class="btn btn-secondary" onclick="restartExecution()">
                    ğŸ”„ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘
                </button>
            ` : `
                <button class="btn btn-primary" onclick="startExecution()" style="flex: 1; max-width: 300px;">
                    ğŸš€ í”„ë¡œì íŠ¸ ì‹¤í–‰ ì‹œì‘
                </button>
            `}
        </div>
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="goToStep(3)">â—€ ì‹¤í–‰ ê³„íš ë³´ê¸°</button>
        </div>
    `;
}
        function startExecution() {
    console.log('=== startExecution ===');
    sessionData.currentExecutionStep = 0;
    sessionData.executionData = [];  // ë¹ˆ ë°°ì—´ë¡œ ì‹œì‘ (undefined ëŒ€ì‹ )
    saveToLocal();
    showToast('ğŸš€ í”„ë¡œì íŠ¸ ì‹¤í–‰ì„ ì‹œì‘í•©ë‹ˆë‹¤!');
    renderExecutionStep(0);
}

        function continueExecution() {
            if (sessionData.currentExecutionStep !== undefined) {
                renderExecutionStep(sessionData.currentExecutionStep);
            } else {
                startExecution();
            }
        }

        function restartExecution() {
            if (confirm('ì •ë§ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê¸°ì¡´ì— ì‘ì„±í•œ ë‚´ìš©ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) {
                startExecution();
            }
        }

        function renderExecutionStep(stepIndex) {
            const timeline = sessionData.timeline;
            
            if (stepIndex >= timeline.length) {
                sessionData.step = 5;
                sessionData.currentExecutionStep = undefined;
                saveToLocal();
                renderStep(5);
                return;
            }
            
            const currentStep = timeline[stepIndex];
            const totalSteps = timeline.length;
            const completedCount = sessionData.executionData ? sessionData.executionData.length : 0;
            
            updateProgress();
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <div class="save-status" id="saveStatus">ğŸ’¾ ë§ˆì§€ë§‰ ì €ì¥: í™•ì¸ ì¤‘...</div>
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 5px;">ğŸ“š í”„ë¡œì íŠ¸ ê³¼ì œ</div>
                        <div style="font-size: 18px; font-weight: 600;">${sessionData.selectedTask}</div>
                    </div>
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ì§„í–‰ ìƒí™©: ${completedCount}/${totalSteps} ì°¨ì‹œ ì™„ë£Œ</div>
                    <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                        ${timeline.map((_, i) => `<div style="flex: 1; height: 8px; background: ${i < completedCount ? '#4ade80' : i === stepIndex ? '#fbbf24' : 'rgba(255,255,255,0.3)'}; border-radius: 4px;"></div>`).join('')}
                    </div>
                    <div style="font-size: 20px; font-weight: 600;">â° ${stepIndex + 1}ì‹œê°„ì°¨: ${currentStep.title}</div>
                </div>
                <div class="timeline-item" style="border-left: 4px solid #10b981; background: #f0fdf4;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #166534; margin: 0;">ğŸ¯ ì´ë²ˆ ì°¨ì‹œ ë¯¸ì…˜</h3>
                        <span style="background: #dcfce7; color: #166534; padding: 6px 12px; border-radius: 6px; font-weight: 600;">â±ï¸ ${currentStep.duration}ë¶„</span>
                    </div>
                    <p style="font-size: 16px; color: #166534; margin-bottom: 20px; font-weight: 500;">${currentStep.mission}</p>
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #374151; margin-bottom: 12px;">ğŸ“‹ ì„¸ë¶€ í™œë™</h4>
                        <ul style="padding-left: 20px; color: #4b5563; line-height: 1.8;">
                            ${currentStep.activities.map(act => `<li>${act}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                <details open class="hint-section" style="margin-bottom: 25px;">
                    <summary style="font-size: 16px; padding: 12px; cursor: pointer;">ğŸ’¡ AI íŒíŠ¸ (${currentStep.hints.length}ê°œ)</summary>
                    <ul class="hint-list" style="margin-top: 12px;">
                        ${currentStep.hints.map(hint => `<li>${hint}</li>`).join('')}
                    </ul>
                </details>
                <div style="background: #fffbeb; border: 2px solid #fbbf24; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <h3 style="color: #b45309; margin-bottom: 15px;">âœï¸ í™œë™ ê¸°ë¡ ì‘ì„±</h3>
                    
                    <!-- â­ AI ë„ìš°ë¯¸ ì„¹ì…˜ ì¶”ê°€ -->
                    <div style="background: linear-gradient(135deg, #e0e7ff 0%, #ddd6fe 100%); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #5b21b6; margin-bottom: 10px;">ğŸ¤– AI ë„ìš°ë¯¸ (ì„ íƒì‚¬í•­)</h4>
                        <p style="color: #6b21a8; font-size: 13px; margin-bottom: 12px;">í‚¤ì›Œë“œë§Œ ì…ë ¥í•˜ë©´ AIê°€ ì™„ì „í•œ ë¬¸ì¥ìœ¼ë¡œ ë§Œë“¤ì–´ë“œë ¤ìš”!</p>
                        <input 
                            type="text" 
                            id="aiKeywords" 
                            class="input-field" 
                            placeholder="ì˜ˆ: ë‰´ìŠ¤ê²€ìƒ‰, í†µê³„í™•ì¸, ë°ì´í„°ë¶„ì„"
                            style="margin-bottom: 10px;"
                        >
                        <button class="btn btn-primary" onclick="generateActivityWithAI()" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            ğŸ¤– AIë¡œ ë¬¸ì¥ ì™„ì„±í•˜ê¸°
                        </button>
                    </div>
                    
                    <p style="color: #78350f; margin-bottom: 12px; font-size: 14px;">ì´ë²ˆ ì°¨ì‹œì— ìˆ˜í–‰í•œ ë‚´ìš©ì„ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”. (ìµœì†Œ 50ì ê¶Œì¥)</p>
                    <textarea class="input-field" id="executionInput" rows="8" placeholder="ì˜ˆì‹œ:
- ì¡°ì‚¬í•œ ë‚´ìš©: 
- ìˆ˜ì§‘í•œ ìë£Œ:
- ëŠë‚€ ì :
- ë‹¤ìŒì— í•  ì¼:" oninput="autoSave(); updateCharCount()"></textarea>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <span id="charCount" style="color: #78350f; font-size: 13px;">0ì</span>
                        <span style="color: #78350f; font-size: 13px;">ğŸ’¡ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í• ìˆ˜ë¡ ë³´ê³ ì„œê°€ í’ì„±í•´ì§‘ë‹ˆë‹¤</span>
                    </div>
                </div>
                <div class="btn-group">
                    ${stepIndex > 0 ? `<button class="btn btn-secondary" onclick="renderExecutionStep(${stepIndex - 1})">â—€ ì´ì „ ì°¨ì‹œ</button>` : ''}
                    <button class="btn btn-secondary" onclick="viewPlanFromExecution()">ğŸ“‹ ê³„íš ë³´ê¸°</button>
                    <button class="btn btn-success" onclick="completeCurrentStep(${stepIndex})" id="completeBtn">
                        ${stepIndex < totalSteps - 1 ? 'ë‹¤ìŒ ì°¨ì‹œë¡œ â–¶' : 'ğŸ‰ í”„ë¡œì íŠ¸ ì™„ë£Œ'}
                    </button>
                </div>
            `;
            
            updateSaveStatus();
            if (sessionData.executionData && sessionData.executionData[stepIndex]) {
                document.getElementById('executionInput').value = sessionData.executionData[stepIndex].content || '';
                updateCharCount();
            }
        }

        function updateCharCount() {
            const input = document.getElementById('executionInput');
            const count = document.getElementById('charCount');
            if (input && count) {
                const length = input.value.length;
                count.textContent = `${length}ì`;
                count.style.color = length >= 50 ? '#15803d' : '#78350f';
            }
        }

        // â­ ì‹¤í–‰ ê¸°ë¡ AI ìƒì„± í•¨ìˆ˜
        async function generateActivityWithAI() {
            const keywords = document.getElementById('aiKeywords').value.trim();
            
            if (!keywords) {
                alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\nì˜ˆ: ë‰´ìŠ¤ê²€ìƒ‰, í†µê³„í™•ì¸, ë°ì´í„°ë¶„ì„');
                return;
            }
            
            const stepIndex = sessionData.currentExecutionStep;
            const currentStep = sessionData.timeline[stepIndex];
            
            const prompt = `ë‹¹ì‹ ì€ ê³ ë“±í•™ìƒì˜ í”„ë¡œì íŠ¸ í™œë™ ê¸°ë¡ì„ ì‘ì„±í•˜ëŠ” ë„ìš°ë¯¸ì…ë‹ˆë‹¤.

[í”„ë¡œì íŠ¸ ì •ë³´]
- ê³¼ì œ: ${sessionData.selectedTask}
- í‚¤ì›Œë“œ: ${sessionData.keyword}
- êµê³¼: ${sessionData.subjects.join(', ')}

[í˜„ì¬ ì°¨ì‹œ]
- ${stepIndex + 1}ì°¨ì‹œ: ${currentStep.title}
- ë¯¸ì…˜: ${currentStep.mission}

[í•™ìƒì´ ì…ë ¥í•œ í‚¤ì›Œë“œ]
${keywords}

ìœ„ í‚¤ì›Œë“œë¥¼ ë°”íƒ•ìœ¼ë¡œ ì´ë²ˆ ì°¨ì‹œì— ìˆ˜í–‰í•œ í™œë™ ë‚´ìš©ì„ 3-4ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
- ê³¼ê±°í˜•ìœ¼ë¡œ ì‘ì„± (ì˜ˆ: ~í•˜ì˜€ë‹¤, ~í–ˆë‹¤)
- êµ¬ì²´ì ì´ê³  ìì—°ìŠ¤ëŸ½ê²Œ
- í•™ìƒì´ ì‹¤ì œë¡œ ìˆ˜í–‰í•œ ê²ƒì²˜ëŸ¼
- ì „ë¬¸ ìš©ì–´ë‚˜ ë„êµ¬ ì´ë¦„ì´ ìˆë‹¤ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©`;
            
            showAILoading(true, 'AIê°€ í™œë™ ê¸°ë¡ì„ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
            
            try {
                const result = await callAI(prompt);
                
                if (result) {
                    const textarea = document.getElementById('executionInput');
                    textarea.value = result;
                    updateCharCount();
                    autoSave();
                    showToast('âœ… AIê°€ í™œë™ ê¸°ë¡ì„ ì‘ì„±í–ˆìŠµë‹ˆë‹¤!');
                    
                    // í‚¤ì›Œë“œ ì…ë ¥ë€ ì´ˆê¸°í™”
                    document.getElementById('aiKeywords').value = '';
                } else {
                    showToast('âŒ AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§ì ‘ ì‘ì„±í•´ì£¼ì„¸ìš”.');
                }
                
            } catch (error) {
                console.error('AI ìƒì„± ì˜¤ë¥˜:', error);
                showToast('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ì‘ì„±í•´ì£¼ì„¸ìš”.');
            } finally {
                showAILoading(false);
            }
        }

        function completeCurrentStep(stepIndex) {
    const input = document.getElementById('executionInput').value.trim();
    
    if (!input) {
        alert('í™œë™ ê¸°ë¡ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (input.length < 20) {
        if (!confirm('í™œë™ ê¸°ë¡ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. (20ì ë¯¸ë§Œ)\nê·¸ë˜ë„ ë‹¤ìŒìœ¼ë¡œ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }
    }
    
    // executionData ì´ˆê¸°í™” í™•ì¸
    if (!sessionData.executionData) {
        sessionData.executionData = [];
    }
    
    // í•´ë‹¹ ì¸ë±ìŠ¤ì— ë°ì´í„° ì €ì¥
    sessionData.executionData[stepIndex] = {
        content: input,
        completedAt: new Date().toISOString()
    };
    
    console.log('=== completeCurrentStep ===');
    console.log('stepIndex:', stepIndex);
    console.log('timeline.length:', sessionData.timeline.length);
    console.log('executionData:', sessionData.executionData);
    
    // ë‹¤ìŒ ì°¨ì‹œë¡œ ì´ë™
    sessionData.currentExecutionStep = stepIndex + 1;
    saveToLocal();
    
    // ë§ˆì§€ë§‰ ì°¨ì‹œ ì™„ë£Œ í™•ì¸
    const completedCount = sessionData.executionData.filter(e => e && e.content).length;
    const totalCount = sessionData.timeline.length;
    
    console.log('completedCount:', completedCount, '/', totalCount);
    
    if (completedCount >= totalCount) {
        // ëª¨ë“  ì°¨ì‹œ ì™„ë£Œ
        showToast('ğŸ‰ ëª¨ë“  ì°¨ì‹œ ì™„ë£Œ!');
        sessionData.step = 5;
        sessionData.currentExecutionStep = undefined;
        saveToLocal();
        renderStep(5);
    } else {
        // ë‹¤ìŒ ì°¨ì‹œë¡œ
        showToast(`âœ… ${stepIndex + 1}ì°¨ì‹œ ì™„ë£Œ!`);
        renderExecutionStep(stepIndex + 1);
    }
}

        function viewPlanFromExecution() {
            const input = document.getElementById('executionInput');
            const stepIndex = sessionData.currentExecutionStep;
            
            if (input && input.value.trim()) {
                if (!sessionData.executionData) {
                    sessionData.executionData = [];
                }
                sessionData.executionData[stepIndex] = {
                    content: input.value.trim(),
                    savedAt: new Date().toISOString()
                };
                saveToLocal();
            }
            renderStep(3);
        }

        function backToExecution() {
            if (sessionData.executionData && sessionData.executionData.length > 0) {
                const lastStep = sessionData.executionData.length - 1;
                sessionData.currentExecutionStep = lastStep;
                renderExecutionStep(lastStep);
            } else {
                sessionData.currentExecutionStep = undefined;
                renderStep(4);
            }
        }

// ==========================================
        // 5ë‹¨ê³„: ì„±ì°°ì¼ì§€ (ë‹¨ë… í™”ë©´)
        // ==========================================
        function renderReflectionJournal() {
            return `
                <div class="step-indicator">[5/8 ë‹¨ê³„] ì„±ì°°ì¼ì§€ ì‘ì„±</div>
                ${renderDataSummary()}
                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 25px; border-radius: 12px; margin-bottom: 30px; text-align: center;">
                    <h2 style="color: #92400e; margin-bottom: 10px;">ğŸ“ í”„ë¡œì íŠ¸ ëŒì•„ë³´ê¸°</h2>
                    <p style="color: #78350f; font-size: 16px; line-height: 1.6;">
                        í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ë©´ì„œ ëŠë‚€ ì ì„ ì„±ì°°í•´ë´…ì‹œë‹¤.
                    </p>
                </div>
                
                <div style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 25px; margin-bottom: 30px;">
                    <h3 style="color: #1e40af; margin-bottom: 20px;">âœ¨ ì„±ì°°ì¼ì§€</h3>
                    
                    ${renderReflectionSection('motivation', 'ğŸ“Œ í”„ë¡œì íŠ¸ ë™ê¸°', generateMotivationRecommendations(), 1, 3)}
                    ${renderReflectionSection('role', 'ğŸ‘¤ ë‚˜ì˜ ì—­í• ', generateRoleRecommendations(), 1, 3)}
                    ${renderReflectionSection('difficulties', 'ğŸš§ ì–´ë ¤ì›€ ê·¹ë³µ ê³¼ì •', generateDifficultiesRecommendations(), 1, 3)}
                    ${renderReflectionSection('learnings', 'ğŸ’¡ ë°°ìš´ ì ', generateLearningsRecommendations(), 2, 5)}
                    ${renderReflectionSection('regrets', 'ğŸ˜” ì•„ì‰¬ìš´ ì ', generateRegretsRecommendations(), 1, 3)}
                    ${renderReflectionSection('future', 'ğŸš€ í–¥í›„ ë°œì „ ë°©í–¥', generateFutureRecommendations(), 2, 4)}
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="backToExecution()">â—€ ì‹¤í–‰ ë‚´ìš© ìˆ˜ì •</button>
                    <button class="btn btn-primary" onclick="submitReflectionJournal()">ë‹¤ìŒ: ìê¸°í‰ê°€ â–¶</button>
                </div>
            `;
        }

        function renderReflectionSection(key, title, recommendations, minSelect, maxSelect) {
            const selected = sessionData.reflectionDetails[key] || [];
            
            return `
                <div style="margin-bottom: 30px; padding-bottom: 30px; border-bottom: 2px dashed #e0e7ff;">
                    <h4 style="color: #374151; margin-bottom: 15px;">${title}</h4>
                    <p style="color: #6b7280; font-size: 14px; margin-bottom: 15px;">
                        ğŸ’¡ AI ì¶”ì²œ í•­ëª© ì¤‘ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš” (ìµœì†Œ ${minSelect}ê°œ, ìµœëŒ€ ${maxSelect}ê°œ)
                    </p>
                    <div id="reflection_${key}">
                        ${recommendations.map((rec, index) => `
                            <div class="recommendation-item ${selected.includes(rec) ? 'selected' : ''}" onclick="toggleReflectionItem('${key}', '${rec.replace(/'/g, "\\'")}', ${maxSelect})">
                                <input type="checkbox" ${selected.includes(rec) ? 'checked' : ''} onclick="event.stopPropagation();">
                                <label>${rec}</label>
                            </div>
                        `).join('')}
                        <div style="margin-top: 10px;">
                            <input type="text" class="input-field" id="custom_${key}" placeholder="âœï¸ ì§ì ‘ ì…ë ¥..." style="margin-bottom: 8px;">
                            <button class="btn btn-secondary" onclick="addCustomReflection('${key}', ${maxSelect})" style="padding: 10px 20px; width: 100%;">ì¶”ê°€í•˜ê¸°</button>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 13px; color: #6b7280;">
                        ì„ íƒí•œ ê°œìˆ˜: <span id="count_${key}" style="font-weight: 600;">${selected.length}</span>ê°œ
                    </div>
                </div>
            `;
        }

        function toggleReflectionItem(key, item, maxSelect) {
            if (!sessionData.reflectionDetails[key]) {
                sessionData.reflectionDetails[key] = [];
            }
            
            const index = sessionData.reflectionDetails[key].indexOf(item);
            if (index > -1) {
                sessionData.reflectionDetails[key].splice(index, 1);
            } else {
                if (sessionData.reflectionDetails[key].length >= maxSelect) {
                    alert(`ìµœëŒ€ ${maxSelect}ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                    return;
                }
                sessionData.reflectionDetails[key].push(item);
            }
            
            autoSave();
            
            // í•´ë‹¹ ì„¹ì…˜ë§Œ ì—…ë°ì´íŠ¸
            updateReflectionSection(key, maxSelect);
        }

        function addCustomReflection(key, maxSelect) {
            const input = document.getElementById(`custom_${key}`);
            const value = input.value.trim();
            
            if (!value) {
                alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!sessionData.reflectionDetails[key]) {
                sessionData.reflectionDetails[key] = [];
            }
            
            if (sessionData.reflectionDetails[key].length >= maxSelect) {
                alert(`ìµœëŒ€ ${maxSelect}ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                return;
            }
            
            sessionData.reflectionDetails[key].push(value);
            input.value = '';
            autoSave();
            showToast('âœ… ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
            
            // í•´ë‹¹ ì„¹ì…˜ë§Œ ì—…ë°ì´íŠ¸
            updateReflectionSection(key, maxSelect);
        }
        
        function updateReflectionSection(key, maxSelect) {
            const container = document.getElementById(`reflection_${key}`);
            if (!container) return;
            
            const selected = sessionData.reflectionDetails[key] || [];
            const recommendations = getRecommendationsForKey(key);
            
            let html = '';
            
            // 1. ì¶”ì²œ í•­ëª© ì¤‘ ì„ íƒëœ ê²ƒ í‘œì‹œ
            recommendations.forEach(function(rec) {
                const isSelected = selected.includes(rec);
                html += `
                    <div class="recommendation-item ${isSelected ? 'selected' : ''}" onclick="toggleReflectionItem('${key}', '${rec.replace(/'/g, "\\'")}', ${maxSelect})">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation();">
                        <label>${rec}</label>
                    </div>
                `;
            });
            
            // 2. ì§ì ‘ ì…ë ¥í•œ í•­ëª© í‘œì‹œ (ì¶”ì²œ í•­ëª©ì— ì—†ëŠ” ê²ƒë“¤)
            selected.forEach(function(item) {
                if (!recommendations.includes(item)) {
                    html += `
                        <div class="recommendation-item selected" onclick="toggleReflectionItem('${key}', '${item.replace(/'/g, "\\'")}', ${maxSelect})">
                            <input type="checkbox" checked onclick="event.stopPropagation();">
                            <label>${item}</label>
                        </div>
                    `;
                }
            });
            
            html += `
                <div style="margin-top: 10px;">
                    <input type="text" class="input-field" id="custom_${key}" placeholder="âœï¸ ì§ì ‘ ì…ë ¥..." style="margin-bottom: 8px;">
                    <button class="btn btn-secondary" onclick="addCustomReflection('${key}', ${maxSelect})" style="padding: 10px 20px; width: 100%;">ì¶”ê°€í•˜ê¸°</button>
                </div>
            `;
            
            container.innerHTML = html;
            
            // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            const countSpan = document.getElementById(`count_${key}`);
            if (countSpan) {
                countSpan.textContent = selected.length;
            }
        }
        
        function getRecommendationsForKey(key) {
            switch(key) {
                case 'motivation': return generateMotivationRecommendations();
                case 'role': return generateRoleRecommendations();
                case 'difficulties': return generateDifficultiesRecommendations();
                case 'learnings': return generateLearningsRecommendations();
                case 'regrets': return generateRegretsRecommendations();
                case 'future': return generateFutureRecommendations();
                default: return [];
            }
        }

        function generateMotivationRecommendations() {
            const keyword = sessionData.keyword;
            const subjects = sessionData.subjects.join('ê³¼ ');
            const taskType = sessionData.selectedTask;
            
            return [
                `í‰ì†Œ ${keyword} ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ë³´ê³  ê´€ì‹¬ì´ ìƒê²¼ìŠµë‹ˆë‹¤`,
                `${keyword} ë¬¸ì œë¥¼ ì§ì ‘ í•´ê²°í•´ë³´ê³  ì‹¶ì—ˆìŠµë‹ˆë‹¤`,
                `${subjects} êµê³¼ë¥¼ ì—°ê³„í•˜ì—¬ ì‹¤ìƒí™œ ë¬¸ì œë¥¼ ë‹¤ë£¨ê³  ì‹¶ì—ˆìŠµë‹ˆë‹¤`,
                `${taskType} ì œì‘ ê¸°ìˆ ì„ ë°°ìš°ê³  ì‹¶ì—ˆìŠµë‹ˆë‹¤`,
                `ìš°ë¦¬ ì§€ì—­ì‚¬íšŒì— ë„ì›€ì´ ë˜ëŠ” í”„ë¡œì íŠ¸ë¥¼ í•˜ê³  ì‹¶ì—ˆìŠµë‹ˆë‹¤`,
                `ë¬¸ì œ í•´ê²° ëŠ¥ë ¥ì„ í‚¤ìš°ê³  ì‹¶ì—ˆìŠµë‹ˆë‹¤`,
                `ì°½ì˜ì ì¸ ê²°ê³¼ë¬¼ì„ ë§Œë“¤ì–´ë³´ê³  ì‹¶ì—ˆìŠµë‹ˆë‹¤`,
                `ìê¸°ì£¼ë„ì  í•™ìŠµ ëŠ¥ë ¥ì„ í–¥ìƒì‹œí‚¤ê³  ì‹¶ì—ˆìŠµë‹ˆë‹¤`
            ];
        }

        function generateRoleRecommendations() {
            return [
                'í”„ë¡œì íŠ¸ ì „ì²´ ê³„íšì„ ìˆ˜ë¦½í–ˆìŠµë‹ˆë‹¤',
                'ìë£Œ ì¡°ì‚¬ ë° ë°ì´í„° ìˆ˜ì§‘ì„ ì£¼ë„í–ˆìŠµë‹ˆë‹¤',
                'ìˆ˜ì§‘í•œ ì •ë³´ë¥¼ ë¶„ì„í•˜ê³  ì •ë¦¬í–ˆìŠµë‹ˆë‹¤',
                'í•´ê²° ë°©ì•ˆì„ êµ¬ìƒí•˜ê³  ì„ ì •í–ˆìŠµë‹ˆë‹¤',
                'ê²°ê³¼ë¬¼ ë””ìì¸ê³¼ ì œì‘ì„ ë‹´ë‹¹í–ˆìŠµë‹ˆë‹¤',
                'í™œë™ ê³¼ì •ì„ ê¼¼ê¼¼íˆ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤',
                'ì „ì²´ ì¼ì •ê³¼ ì‹œê°„ì„ ê´€ë¦¬í–ˆìŠµë‹ˆë‹¤'
            ];
        }

        function generateDifficultiesRecommendations() {
            return [
                'ì ì ˆí•œ ìë£Œë¥¼ ì°¾ëŠ” ë° ì–´ë ¤ì›€ì´ ìˆì—ˆì§€ë§Œ, ë‹¤ì–‘í•œ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•˜ì—¬ í•´ê²°í–ˆìŠµë‹ˆë‹¤',
                'ì •ë³´ê°€ ë„ˆë¬´ ë§ì•„ í˜¼ë€ìŠ¤ëŸ¬ì› ì§€ë§Œ, í•µì‹¬ë§Œ ì¶”ë ¤ë‚´ëŠ” ë°©ë²•ì„ ë°°ì› ìŠµë‹ˆë‹¤',
                'ì‹œê°„ì´ ë¶€ì¡±í–ˆì§€ë§Œ, ìš°ì„ ìˆœìœ„ë¥¼ ì •í•´ íš¨ìœ¨ì ìœ¼ë¡œ ì§„í–‰í–ˆìŠµë‹ˆë‹¤',
                'ë””ìì¸ ë„êµ¬ ì‚¬ìš©ì´ ì–´ë ¤ì› ì§€ë§Œ, íŠœí† ë¦¬ì–¼ì„ ë³´ë©° ìµí˜”ìŠµë‹ˆë‹¤',
                'ì–´ë–¤ í•´ê²° ë°©ì•ˆì„ ì„ íƒí• ì§€ ê³ ë¯¼í–ˆì§€ë§Œ, ì¥ë‹¨ì ì„ ë¹„êµí•˜ì—¬ ê²°ì •í–ˆìŠµë‹ˆë‹¤',
                'ì¤‘ê°„ì— ë°©í–¥ì„ ìƒì—ˆì§€ë§Œ, ê³„íšì„ ë‹¤ì‹œ ì ê²€í•˜ë©° ë°”ë¡œì¡ì•˜ìŠµë‹ˆë‹¤',
                'ìƒê°ë³´ë‹¤ ë¶„ëŸ‰ì´ ë§ì•„ ë‹¹í™©í–ˆì§€ë§Œ, ì°¨ê·¼ì°¨ê·¼ ì§„í–‰í•˜ì—¬ ì™„ì„±í–ˆìŠµë‹ˆë‹¤',
                'ê¸°ìˆ ì  ë¬¸ì œê°€ ë°œìƒí–ˆì§€ë§Œ, ì¸í„°ë„· ê²€ìƒ‰ê³¼ ì‹œí–‰ì°©ì˜¤ë¡œ í•´ê²°í–ˆìŠµë‹ˆë‹¤',
                'ì™„ë²½í•˜ê²Œ í•˜ê³  ì‹¶ì–´ ë¶€ë‹´ì´ ì»¸ì§€ë§Œ, í•  ìˆ˜ ìˆëŠ” ë§Œí¼ ìµœì„ ì„ ë‹¤í–ˆìŠµë‹ˆë‹¤',
                'ë™ê¸°ë¶€ì—¬ê°€ ë–¨ì–´ì§ˆ ë•Œê°€ ìˆì—ˆì§€ë§Œ, ìµœì¢… ëª©í‘œë¥¼ ìƒê°í•˜ë©° ë²„í…¼ìŠµë‹ˆë‹¤'
            ];
        }

        function generateLearningsRecommendations() {
            const hasFullExecution = sessionData.executionData && 
                                     sessionData.executionData.length === sessionData.timeline.length;
            
            return [
                'ë¬¸ì œë¥¼ ì²´ê³„ì ìœ¼ë¡œ ë¶„ì„í•˜ëŠ” ë°©ë²•ì„ ë°°ì› ìŠµë‹ˆë‹¤',
                'ìë£Œ ì¡°ì‚¬ì™€ ì •ë³´ ìˆ˜ì§‘ì˜ ì¤‘ìš”ì„±ì„ ì•Œê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤',
                'ìˆ˜ì§‘í•œ ì •ë³´ë¥¼ ë¹„íŒì ìœ¼ë¡œ í‰ê°€í•˜ëŠ” ëŠ¥ë ¥ì´ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤',
                'ê³„íšì˜ ì¤‘ìš”ì„±ê³¼ ê³„íšëŒ€ë¡œ ì‹¤í–‰í•˜ëŠ” ìê¸°ì£¼ë„ì„±ì„ ê¸°ë¥¼ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤',
                'ë””ì§€í„¸ ë„êµ¬ë¥¼ í™œìš©í•œ ê²°ê³¼ë¬¼ ì œì‘ ëŠ¥ë ¥ì´ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤',
                'ë³µì¡í•œ ë¬¸ì œë„ ë‹¨ê³„ë³„ë¡œ ë‚˜ëˆ„ë©´ í•´ê²°í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ë°°ì› ìŠµë‹ˆë‹¤',
                'ì‹œê°„ ê´€ë¦¬ì™€ ìš°ì„ ìˆœìœ„ ì„¤ì •ì˜ ì¤‘ìš”ì„±ì„ ê¹¨ë‹¬ì•˜ìŠµë‹ˆë‹¤',
                hasFullExecution ? 'ëê¹Œì§€ ì™„ìˆ˜í•˜ëŠ” ëˆê¸°ì™€ ì±…ì„ê°ì„ ê¸°ë¥¼ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤' : 'ì‹œê°„ ê´€ë¦¬ì˜ ì–´ë ¤ì›€ì„ ê²½í—˜í–ˆìŠµë‹ˆë‹¤',
                'ì°½ì˜ì ìœ¼ë¡œ ìƒê°í•˜ê³  í‘œí˜„í•˜ëŠ” ë°©ë²•ì„ ë°°ì› ìŠµë‹ˆë‹¤',
                'ì‹¤ìƒí™œ ë¬¸ì œì— ê´€ì‹¬ì„ ê°–ê³  í•´ê²°í•˜ë ¤ëŠ” íƒœë„ê°€ ìƒê²¼ìŠµë‹ˆë‹¤',
                'êµê³¼ ì§€ì‹ì„ ì‹¤ì œ ë¬¸ì œì— ì ìš©í•˜ëŠ” ë°©ë²•ì„ ì•Œê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤',
                'í˜¼ìì„œë„ í”„ë¡œì íŠ¸ë¥¼ ì™„ì„±í•  ìˆ˜ ìˆë‹¤ëŠ” ìì‹ ê°ì´ ìƒê²¼ìŠµë‹ˆë‹¤'
            ];
        }

        function generateRegretsRecommendations() {
            return [
                'ë” ë‹¤ì–‘í•œ ìë£Œë¥¼ ì¡°ì‚¬í•˜ì§€ ëª»í•´ ì•„ì‰¬ì› ìŠµë‹ˆë‹¤',
                'ì‹œê°„ì´ ë¶€ì¡±í•´ ê²°ê³¼ë¬¼ì„ ë” ì™„ì„±ë„ ìˆê²Œ ë§Œë“¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤',
                'ë” ì°½ì˜ì ì¸ ì•„ì´ë””ì–´ë¥¼ ë‚´ì§€ ëª»í•œ ê²ƒì´ ì•„ì‰½ìŠµë‹ˆë‹¤',
                'ê³„íšë³´ë‹¤ ì‹¤í–‰ì— ì‹œê°„ì´ ë” ê±¸ë ¤ ì¼ì •ì´ ë°€ë ¸ìŠµë‹ˆë‹¤',
                'ì¤‘ê°„ ì ê²€ì„ ìì£¼ í•˜ì§€ ëª»í•´ ë°©í–¥ì„ ìƒì„ ë»”í–ˆìŠµë‹ˆë‹¤',
                'ë””ìì¸ ì‹¤ë ¥ì´ ë¶€ì¡±í•´ ì›í•˜ëŠ” ë§Œí¼ í‘œí˜„í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤',
                'ë” ê¹Šì´ ìˆê²Œ ë¶„ì„í•˜ì§€ ëª»í•œ ì ì´ ì•„ì‰½ìŠµë‹ˆë‹¤',
                'ë‹¤ë¥¸ ì‚¬ëŒì˜ ì˜ê²¬ì„ ë“£ì§€ ëª»í•´ ë‹¤ì–‘í•œ ê´€ì ì„ ë†“ì³¤ìŠµë‹ˆë‹¤',
                'ë” ì²´ê³„ì ìœ¼ë¡œ ê¸°ë¡í•˜ì§€ ëª»í•´ ë‚˜ì¤‘ì— ì •ë¦¬ê°€ ì–´ë ¤ì› ìŠµë‹ˆë‹¤',
                'ì²˜ìŒë¶€í„° ë” ì ê·¹ì ìœ¼ë¡œ ì‹œì‘í•˜ì§€ ëª»í•œ ê²ƒì´ ì•„ì‰½ìŠµë‹ˆë‹¤'
            ];
        }

        function generateFutureRecommendations() {
            return [
                'ë‹¤ìŒì—ëŠ” ë” ì²´ê³„ì ìœ¼ë¡œ ê³„íšì„ ì„¸ìš°ê³  ì‹¤í–‰í•˜ê² ìŠµë‹ˆë‹¤',
                'ì •ë³´ ë¶„ì„ ëŠ¥ë ¥ì„ ë” í‚¤ìš°ê¸° ìœ„í•´ ë…¸ë ¥í•˜ê² ìŠµë‹ˆë‹¤',
                'ë””ìì¸ ë„êµ¬ í™œìš© ëŠ¥ë ¥ì„ ë” í–¥ìƒì‹œí‚¤ê² ìŠµë‹ˆë‹¤',
                'ì‹œê°„ ê´€ë¦¬ ëŠ¥ë ¥ì„ ê¸°ë¥´ê¸° ìœ„í•´ ì—°ìŠµí•˜ê² ìŠµë‹ˆë‹¤',
                'ë” ì°½ì˜ì ì¸ ì•„ì´ë””ì–´ë¥¼ ë‚´ê¸° ìœ„í•´ ë‹¤ì–‘í•œ ì‚¬ë¡€ë¥¼ ì—°êµ¬í•˜ê² ìŠµë‹ˆë‹¤',
                'ë¹„ìŠ·í•œ ì£¼ì œë¡œ ì‹¬í™” í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•´ë³´ê³  ì‹¶ìŠµë‹ˆë‹¤',
                'ë‹¤ë¥¸ ë¶„ì•¼ì™€ ìœµí•©í•œ í”„ë¡œì íŠ¸ì— ë„ì „í•´ë³´ê³  ì‹¶ìŠµë‹ˆë‹¤',
                'ì‹¤ì œë¡œ ì§€ì—­ì‚¬íšŒ ë¬¸ì œ í•´ê²°ì— ê¸°ì—¬í•˜ëŠ” í™œë™ì„ í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤',
                'í”„ë¡œì íŠ¸ ê²°ê³¼ë¥¼ ë” ë§ì€ ì‚¬ëŒë“¤ê³¼ ê³µìœ í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤',
                'ì§€ì†ì ìœ¼ë¡œ ê´€ì‹¬ ë¶„ì•¼ë¥¼ íƒêµ¬í•˜ë©° ì „ë¬¸ì„±ì„ í‚¤ìš°ê³  ì‹¶ìŠµë‹ˆë‹¤'
            ];
        }

        function submitReflectionJournal() {
            const reflectionCounts = {
                motivation: sessionData.reflectionDetails.motivation?.length || 0,
                role: sessionData.reflectionDetails.role?.length || 0,
                difficulties: sessionData.reflectionDetails.difficulties?.length || 0,
                learnings: sessionData.reflectionDetails.learnings?.length || 0,
                regrets: sessionData.reflectionDetails.regrets?.length || 0,
                future: sessionData.reflectionDetails.future?.length || 0
            };
            
            const minRequirements = {
                motivation: 1, role: 1, difficulties: 1, learnings: 2, regrets: 1, future: 2
            };
            
            for (const key in minRequirements) {
                if (reflectionCounts[key] < minRequirements[key]) {
                    alert(`ì„±ì°°ì¼ì§€ë¥¼ ì™„ì„±í•´ì£¼ì„¸ìš”.\nê° í•­ëª©ì˜ ìµœì†Œ ì„ íƒ ê°œìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.`);
                    return;
                }
            }
            
            sessionData.step = 6;
            saveToLocal();
            showToast('âœ… ì„±ì°°ì¼ì§€ ì™„ë£Œ');
            renderStep(6);
        }

        // ==========================================
        // 6ë‹¨ê³„: ìê¸°í‰ê°€ (ë‹¨ë… í™”ë©´)
        // ==========================================
        function renderSelfEvaluationPage() {
            const evaluations = generateSelfEvaluations();
            
            return `
                <div class="step-indicator">[6/8 ë‹¨ê³„] ìê¸°í‰ê°€ì„œ ì‘ì„±</div>
                ${renderDataSummary()}
                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 25px; border-radius: 12px; margin-bottom: 30px; text-align: center;">
                    <h2 style="color: #92400e; margin-bottom: 10px;">ğŸ“Š ìŠ¤ìŠ¤ë¡œ í‰ê°€í•˜ê¸°</h2>
                    <p style="color: #78350f; font-size: 16px; line-height: 1.6;">
                        í”„ë¡œì íŠ¸ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìì‹ ì„ í‰ê°€í•´ë´…ì‹œë‹¤.
                    </p>
                </div>
                
                <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 25px; margin-bottom: 30px;">
                    <h3 style="color: #92400e; margin-bottom: 20px;">ğŸ“Š ìê¸°í‰ê°€ì„œ</h3>
                    <p style="color: #78350f; margin-bottom: 20px; font-size: 14px;">
                        í”„ë¡œì íŠ¸ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ AIê°€ ì¶”ì²œí•˜ëŠ” í‰ê°€ í•­ëª©ì…ë‹ˆë‹¤.<br>
                        ê° ì˜ì—­ì—ì„œ í•´ë‹¹í•˜ëŠ” í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”. (ê° ì˜ì—­ ìµœì†Œ 1ê°œ)
                    </p>
                    
                    ${evaluations.map((category, catIndex) => {
                        const categoryKey = `eval_${catIndex}`;
                        const selected = sessionData.selfEvaluation[categoryKey] || [];
                        
                        return `
                            <div style="margin-bottom: 25px; padding: 20px; background: white; border-radius: 10px;" data-category="${categoryKey}">
                                <h4 style="color: #1e40af; margin-bottom: 15px;">${catIndex + 1}ï¸âƒ£ ${category.category}</h4>
                                ${category.items.map((item, itemIndex) => `
                                    <div class="recommendation-item ${selected.includes(item) ? 'selected' : ''}" onclick="toggleEvaluationItem('${categoryKey}', '${item.replace(/'/g, "\\'")}', 3)">
                                        <input type="checkbox" ${selected.includes(item) ? 'checked' : ''} onclick="event.stopPropagation();">
                                        <label>${item}</label>
                                    </div>
                                `).join('')}
                                <div style="margin-top: 10px;">
                                    <input type="text" class="input-field" id="custom_${categoryKey}" placeholder="âœï¸ ì§ì ‘ ì…ë ¥..." style="margin-bottom: 8px;">
                                    <button class="btn btn-secondary" onclick="addCustomEvaluation('${categoryKey}', 3)" style="padding: 8px 16px; width: 100%;">ì¶”ê°€í•˜ê¸°</button>
                                </div>
                                <div style="margin-top: 10px; font-size: 13px; color: #6b7280;">
                                    ì„ íƒ: <span style="font-weight: 600;">${selected.length}</span>ê°œ
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                ${renderProjectReview()}
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="goToStep(5)">â—€ ì„±ì°°ì¼ì§€ë¡œ</button>
                    <button class="btn btn-primary" onclick="submitSelfEvaluation()">ë‹¤ìŒ: ì´í•´ë„ í€´ì¦ˆ â–¶</button>
                </div>
            `;
        }

        function generateSelfEvaluations() {
            const completionRate = sessionData.executionData ? 
                sessionData.executionData.length / sessionData.timeline.length : 0;
            const hasRichContent = sessionData.executionData ? 
                sessionData.executionData.some(e => e.content.length > 200) : false;
            const totalHours = sessionData.totalHours;
            
            return [
                {
                    category: "ê³„íš ìˆ˜ë¦½",
                    items: [
                        "í”„ë¡œì íŠ¸ ëª©í‘œë¥¼ ëª…í™•íˆ ì„¤ì •í–ˆë‹¤",
                        `${totalHours}ì‹œê°„ ê³„íšì„ ì²´ê³„ì ìœ¼ë¡œ ìˆ˜ë¦½í–ˆë‹¤`,
                        "ì°¨ì‹œë³„ í™œë™ì„ êµ¬ì²´ì ìœ¼ë¡œ ê³„íší–ˆë‹¤",
                        "ì‹¤í˜„ ê°€ëŠ¥í•œ ê³„íšì„ ì„¸ì› ë‹¤",
                        "ê³„íš ìˆ˜ë¦½ ì‹œ ì¶©ë¶„íˆ ê³ ë¯¼í–ˆë‹¤"
                    ]
                },
                {
                    category: "ì‹¤í–‰ ë° ì™„ì„±ë„",
                    items: [
                        completionRate === 1 ? "ëª¨ë“  ì°¨ì‹œë¥¼ ê³„íšëŒ€ë¡œ ì™„ìˆ˜í–ˆë‹¤" : "ê³„íšì˜ ëŒ€ë¶€ë¶„ì„ ì‹¤í–‰í–ˆë‹¤",
                        "ê° ì°¨ì‹œ í™œë™ì„ ì„±ì‹¤íˆ ìˆ˜í–‰í–ˆë‹¤",
                        hasRichContent ? "í™œë™ ë‚´ìš©ì„ êµ¬ì²´ì ìœ¼ë¡œ ê¸°ë¡í–ˆë‹¤" : "í™œë™ ë‚´ìš©ì„ ê¸°ë¡í–ˆë‹¤",
                        "ê²°ê³¼ë¬¼ì„ ì™„ì„±í–ˆë‹¤",
                        "ìµœì„ ì„ ë‹¤í•´ í”„ë¡œì íŠ¸ë¥¼ ìˆ˜í–‰í–ˆë‹¤"
                    ]
                },
                {
                    category: "ë¬¸ì œ í•´ê²°",
                    items: [
                        `${sessionData.keyword} ë¬¸ì œë¥¼ ê¹Šì´ ìˆê²Œ ë¶„ì„í–ˆë‹¤`,
                        "ì‹¤í˜„ ê°€ëŠ¥í•œ í•´ê²° ë°©ì•ˆì„ ì œì‹œí–ˆë‹¤",
                        "ì–´ë ¤ì›€ì„ ìŠ¤ìŠ¤ë¡œ ê·¹ë³µí•˜ë ¤ ë…¸ë ¥í–ˆë‹¤",
                        "ë¬¸ì œì˜ ì›ì¸ì„ íŒŒì•…í•˜ë ¤ ë…¸ë ¥í–ˆë‹¤",
                        "ë‹¤ì–‘í•œ í•´ê²° ë°©ë²•ì„ ê³ ë¯¼í–ˆë‹¤"
                    ]
                },
                {
                    category: "ì°½ì˜ì„±",
                    items: [
                        "ë…ì°½ì ì¸ ì•„ì´ë””ì–´ë¥¼ ì œì‹œí–ˆë‹¤",
                        "ê¸°ì¡´ê³¼ ë‹¤ë¥¸ ê´€ì ì—ì„œ ì ‘ê·¼í–ˆë‹¤",
                        "ë‹¤ì–‘í•œ ìë£Œë¥¼ ì°½ì˜ì ìœ¼ë¡œ í™œìš©í–ˆë‹¤",
                        "ê²°ê³¼ë¬¼ì„ ì°½ì˜ì ìœ¼ë¡œ í‘œí˜„í–ˆë‹¤",
                        "ìƒˆë¡œìš´ ë°©ë²•ì„ ì‹œë„í–ˆë‹¤"
                    ]
                },
                {
                    category: "ìê¸°ì£¼ë„ì„±",
                    items: [
                        "ìŠ¤ìŠ¤ë¡œ ê³„íší•˜ê³  ì‹¤í–‰í–ˆë‹¤",
                        "ëŠ¥ë™ì ìœ¼ë¡œ ìë£Œë¥¼ ì°¾ê³  í•™ìŠµí–ˆë‹¤",
                        "ì£¼ë„ì ìœ¼ë¡œ ë¬¸ì œë¥¼ í•´ê²°í–ˆë‹¤",
                        "ë„ì›€ ì—†ì´ í˜¼ìì„œ ì§„í–‰í–ˆë‹¤",
                        "ì ê·¹ì ìœ¼ë¡œ í”„ë¡œì íŠ¸ì— ì„í–ˆë‹¤"
                    ]
                },
                {
                    category: "ì˜ì‚¬ì†Œí†µ",
                    items: [
                        "ì¡°ì‚¬ ë‚´ìš©ì„ ëª…í™•í•˜ê²Œ ì •ë¦¬í–ˆë‹¤",
                        "ê²°ê³¼ë¬¼ì„ íš¨ê³¼ì ìœ¼ë¡œ í‘œí˜„í–ˆë‹¤",
                        "ë…¼ë¦¬ì ìœ¼ë¡œ ë‚´ìš©ì„ êµ¬ì„±í–ˆë‹¤",
                        "í•µì‹¬ì„ ì˜ ì „ë‹¬í–ˆë‹¤",
                        "ì´í•´í•˜ê¸° ì‰½ê²Œ ì‘ì„±í–ˆë‹¤"
                    ]
                },
                {
                    category: "ì •ë³´ í™œìš©",
                    items: [
                        "ë‹¤ì–‘í•œ ì •ë³´ì›ì„ í™œìš©í–ˆë‹¤",
                        "ìˆ˜ì§‘í•œ ì •ë³´ë¥¼ ì ì ˆíˆ ë¶„ì„í–ˆë‹¤",
                        "ë””ì§€í„¸ ë„êµ¬ë¥¼ íš¨ê³¼ì ìœ¼ë¡œ ì‚¬ìš©í–ˆë‹¤",
                        "ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ìë£Œë¥¼ ì°¾ì•˜ë‹¤",
                        "ì •ë³´ë¥¼ ë¹„íŒì ìœ¼ë¡œ í‰ê°€í–ˆë‹¤"
                    ]
                },
                {
                    category: "ì‹œê°„ ê´€ë¦¬",
                    items: [
                        completionRate === 1 ? "ê³„íšëœ ì‹œê°„ ë‚´ì— ì™„ë£Œí–ˆë‹¤" : "ì‹œê°„ ê´€ë¦¬ë¥¼ ìœ„í•´ ë…¸ë ¥í–ˆë‹¤",
                        "ìš°ì„ ìˆœìœ„ë¥¼ ì •í•˜ì—¬ ì‹¤í–‰í–ˆë‹¤",
                        "ì‹œê°„ì„ íš¨ìœ¨ì ìœ¼ë¡œ í™œìš©í–ˆë‹¤",
                        "ë§ˆê° ì‹œê°„ì„ ì§€ì¼°ë‹¤",
                        "ì¼ì •ì„ ê´€ë¦¬í•˜ë ¤ ë…¸ë ¥í–ˆë‹¤"
                    ]
                },
                {
                    category: "ì„±ì°° ë° ê°œì„ ",
                    items: [
                        "í”„ë¡œì íŠ¸ ê³¼ì •ì„ ëŒì•„ë³´ë©° ë°˜ì„±í–ˆë‹¤",
                        "ê°œì„ ì ì„ ì°¾ì•„ ì ìš©í–ˆë‹¤",
                        "ë°°ìš´ ì ì„ ëª…í™•íˆ ì¸ì‹í–ˆë‹¤",
                        "ìŠ¤ìŠ¤ë¡œë¥¼ ê°ê´€ì ìœ¼ë¡œ í‰ê°€í–ˆë‹¤",
                        "ë‹¤ìŒ í”„ë¡œì íŠ¸ë¥¼ ìœ„í•œ êµí›ˆì„ ì–»ì—ˆë‹¤"
                    ]
                },
                {
                    category: "í•™ìŠµ íƒœë„",
                    items: [
                        "ì„±ì‹¤í•˜ê²Œ ì„í–ˆë‹¤",
                        "ëˆê¸°ìˆê²Œ ì™„ìˆ˜í•˜ë ¤ ë…¸ë ¥í–ˆë‹¤",
                        "ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í–ˆë‹¤",
                        "ì±…ì„ê°ì„ ê°€ì§€ê³  ìˆ˜í–‰í–ˆë‹¤",
                        "ì§„ì§€í•œ ìì„¸ë¡œ ì„í–ˆë‹¤"
                    ]
                }
            ];
        }

        function toggleEvaluationItem(categoryKey, item, maxSelect) {
            if (!sessionData.selfEvaluation[categoryKey]) {
                sessionData.selfEvaluation[categoryKey] = [];
            }
            
            const index = sessionData.selfEvaluation[categoryKey].indexOf(item);
            if (index > -1) {
                sessionData.selfEvaluation[categoryKey].splice(index, 1);
            } else {
                if (sessionData.selfEvaluation[categoryKey].length >= maxSelect) {
                    alert(`ìµœëŒ€ ${maxSelect}ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                    return;
                }
                sessionData.selfEvaluation[categoryKey].push(item);
            }
            
            autoSave();
            renderStep(6);
        }

        function addCustomEvaluation(categoryKey, maxSelect) {
            const input = document.getElementById(`custom_${categoryKey}`);
            const value = input.value.trim();
            
            if (!value) {
                alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!sessionData.selfEvaluation[categoryKey]) {
                sessionData.selfEvaluation[categoryKey] = [];
            }
            
            if (sessionData.selfEvaluation[categoryKey].length >= maxSelect) {
                alert(`ìµœëŒ€ ${maxSelect}ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                return;
            }
            
            sessionData.selfEvaluation[categoryKey].push(value);
            input.value = '';
            autoSave();
            showToast('âœ… ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
            
            // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ë§Œ ì—…ë°ì´íŠ¸
            updateEvaluationCategory(categoryKey, maxSelect);
        }
        
        function updateEvaluationCategory(categoryKey, maxSelect) {
            const catIndex = parseInt(categoryKey.replace('eval_', ''));
            const evaluations = generateSelfEvaluations();
            const category = evaluations[catIndex];
            const selected = sessionData.selfEvaluation[categoryKey] || [];
            
            // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ HTML ì¬ìƒì„±
            const categoryDiv = document.querySelector(`[data-category="${categoryKey}"]`);
            if (!categoryDiv) return;
            
            let html = `<h4 style="color: #1e40af; margin-bottom: 15px;">${catIndex + 1}ï¸âƒ£ ${category.category}</h4>`;
            
            // 1. ì¶”ì²œ í•­ëª© ì¤‘ ì„ íƒëœ ê²ƒ í‘œì‹œ
            category.items.forEach(function(item) {
                const isSelected = selected.includes(item);
                html += `
                    <div class="recommendation-item ${isSelected ? 'selected' : ''}" onclick="toggleEvaluationItem('${categoryKey}', '${item.replace(/'/g, "\\'")}', ${maxSelect})">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation();">
                        <label>${item}</label>
                    </div>
                `;
            });
            
            // 2. ì§ì ‘ ì…ë ¥í•œ í•­ëª© í‘œì‹œ (ì¶”ì²œ í•­ëª©ì— ì—†ëŠ” ê²ƒë“¤)
            selected.forEach(function(item) {
                if (!category.items.includes(item)) {
                    html += `
                        <div class="recommendation-item selected" onclick="toggleEvaluationItem('${categoryKey}', '${item.replace(/'/g, "\\'")}', ${maxSelect})">
                            <input type="checkbox" checked onclick="event.stopPropagation();">
                            <label>${item}</label>
                        </div>
                    `;
                }
            });
            
            html += `
                <div style="margin-top: 10px;">
                    <input type="text" class="input-field" id="custom_${categoryKey}" placeholder="âœï¸ ì§ì ‘ ì…ë ¥..." style="margin-bottom: 8px;">
                    <button class="btn btn-secondary" onclick="addCustomEvaluation('${categoryKey}', ${maxSelect})" style="padding: 8px 16px; width: 100%;">ì¶”ê°€í•˜ê¸°</button>
                </div>
                <div style="margin-top: 10px; font-size: 13px; color: #6b7280;">
                    ì„ íƒ: <span style="font-weight: 600;">${selected.length}</span>ê°œ
                </div>
            `;
            
            categoryDiv.innerHTML = html;
        }

        function renderProjectReview() {
            const review = analyzeProject();
            
            return `
                <!-- â­ AI ìƒê¸°ë¶€ ìƒì„± ì„¹ì…˜ ì¶”ê°€ -->
                <div style="background: linear-gradient(135deg, #e0e7ff 0%, #ddd6fe 100%); border: 3px solid #7c3aed; border-radius: 12px; padding: 25px; margin-bottom: 30px;">
                    <h3 style="color: #5b21b6; margin-bottom: 15px;">ğŸ¤– AI ìƒê¸°ë¶€ ìë™ ìƒì„±</h3>
                    <p style="color: #6b21a8; margin-bottom: 20px; font-size: 14px; line-height: 1.6;">
                        AIê°€ ì—¬ëŸ¬ë¶„ì˜ í™œë™ ê¸°ë¡ì„ ë¶„ì„í•˜ì—¬ êµ¬ì²´ì ì´ê³  ì°¨ë³„í™”ëœ ìƒê¸°ë¶€ë¥¼ ì‘ì„±í•´ë“œë¦½ë‹ˆë‹¤!<br>
                        ê¸°ì¡´ í…œí”Œë¦¿ ë°©ì‹ë³´ë‹¤ í›¨ì”¬ ìƒì„¸í•˜ê³  ê°œì¸í™”ëœ ë‚´ìš©ì„ ë°›ì•„ë³´ì„¸ìš”.
                    </p>
                    <button 
                        class="btn btn-primary" 
                        onclick="generateSeosaenggibuWithAI()" 
                        style="width: 100%; background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); font-size: 16px; padding: 15px;"
                    >
                        ğŸ¤– AIë¡œ ìƒê¸°ë¶€ ë‹¤ì‹œ ì“°ê¸°
                    </button>
                    <div id="aiSeosaenggibuResult" style="margin-top: 20px; display: none;">
                        <div style="background: white; padding: 20px; border-radius: 10px;">
                            <h4 style="color: #5b21b6; margin-bottom: 15px;">âœ¨ AI ìƒì„± ìƒê¸°ë¶€</h4>
                            <div id="aiSeosaenggibuText" style="color: #374151; line-height: 1.8; white-space: pre-wrap;"></div>
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                <button class="btn btn-success" onclick="useAISeosaenggibu()" style="flex: 1;">
                                    âœ… AI ìƒê¸°ë¶€ ì‚¬ìš©í•˜ê¸°
                                </button>
                                <button class="btn btn-secondary" onclick="regenerateSeosaenggibu()" style="flex: 1;">
                                    ğŸ”„ ë‹¤ì‹œ ìƒì„±
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            
                <div style="background: #f0fdf4; border: 2px solid #10b981; border-radius: 12px; padding: 25px; margin-bottom: 30px;">
                    <h3 style="color: #15803d; margin-bottom: 20px;">ğŸ” í”„ë¡œì íŠ¸ ê²€í† </h3>
                    <p style="color: #166534; margin-bottom: 20px; font-size: 14px;">
                        AIê°€ í”„ë¡œì íŠ¸ë¥¼ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤. ì œì¶œ ì „ í™•ì¸í•´ë³´ì„¸ìš”.
                    </p>
                    
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                        <h4 style="color: #374151; margin-bottom: 15px;">âœ… ì˜í•œ ì </h4>
                        <ul style="padding-left: 20px; color: #4b5563; line-height: 1.8;">
                            ${review.strengths.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
                    
                    ${review.improvements.length > 0 ? `
                        <div style="background: #fffbeb; padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #fbbf24;">
                            <h4 style="color: #92400e; margin-bottom: 15px;">ğŸ’¡ ê°œì„  ê¶Œì¥ì‚¬í•­</h4>
                            <ul style="padding-left: 20px; color: #78350f; line-height: 1.8;">
                                ${review.improvements.map(i => `<li>${i}</li>`).join('')}
                            </ul>
                            <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 8px;">
                                <strong style="color: #92400e;">ğŸ’­ ê¶Œì¥ì‚¬í•­:</strong>
                                <p style="color: #78350f; margin-top: 8px; line-height: 1.6;">
                                    ìœ„ í•­ëª©ë“¤ì„ ìˆ˜ì •í•˜ë©´ ë” ì¢‹ì€ ë³´ê³ ì„œê°€ ë©ë‹ˆë‹¤. "â—€ ì‹¤í–‰ ë‚´ìš© ìˆ˜ì •" ë²„íŠ¼ìœ¼ë¡œ ëŒì•„ê°€ì„œ ë³´ì™„í•˜ëŠ” ê²ƒì„ ì¶”ì²œí•©ë‹ˆë‹¤.
                                </p>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="background: white; padding: 20px; border-radius: 10px;">
                        <h4 style="color: #374151; margin-bottom: 15px;">ğŸ“Š ì™„ì„±ë„ í‰ê°€</h4>
                        <div style="margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: #6b7280; font-size: 14px;">ì‹¤í–‰ ì™„ë£Œìœ¨</span>
                                <span style="color: #1f2937; font-weight: 600;">${review.completionRate}%</span>
                            </div>
                            <div style="background: #e5e7eb; height: 10px; border-radius: 5px; overflow: hidden;">
                                <div style="background: ${review.completionRate === 100 ? '#10b981' : '#f59e0b'}; height: 100%; width: ${review.completionRate}%;"></div>
                            </div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: #6b7280; font-size: 14px;">í‰ê·  ê¸°ë¡ ê¸¸ì´</span>
                                <span style="color: #1f2937; font-weight: 600;">${review.avgLength}ì</span>
                            </div>
                            <div style="background: #e5e7eb; height: 10px; border-radius: 5px; overflow: hidden;">
                                <div style="background: ${review.avgLength >= 100 ? '#10b981' : '#f59e0b'}; height: 100%; width: ${Math.min(review.avgLength / 2, 100)}%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function analyzeProject() {
            const totalSteps = sessionData.timeline ? sessionData.timeline.length : 1;
            const completedSteps = sessionData.executionData ? sessionData.executionData.length : 0;
            const completionRate = Math.round((completedSteps / totalSteps) * 100);
            
            const totalChars = sessionData.executionData ? 
                sessionData.executionData.reduce((sum, e) => sum + e.content.length, 0) : 0;
            const avgLength = completedSteps > 0 ? Math.round(totalChars / completedSteps) : 0;
            
            const strengths = [];
            const improvements = [];
            
            if (completionRate === 100) {
                strengths.push('ëª¨ë“  ì°¨ì‹œë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤');
            } else if (completionRate >= 75) {
                strengths.push('ëŒ€ë¶€ë¶„ì˜ ì°¨ì‹œë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤');
            }
            
            if (avgLength >= 150) {
                strengths.push('í™œë™ ë‚´ìš©ì„ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤');
            } else if (avgLength >= 80) {
                strengths.push('í™œë™ ë‚´ìš©ì„ ì‘ì„±í–ˆìŠµë‹ˆë‹¤');
            }
            
            if (sessionData.reflectionDetails.learnings && sessionData.reflectionDetails.learnings.length >= 3) {
                strengths.push('ë°°ìš´ ì ì„ ì¶©ë¶„íˆ ì„±ì°°í–ˆìŠµë‹ˆë‹¤');
            }
            
            if (completionRate < 100) {
                improvements.push(`${totalSteps - completedSteps}ê°œ ì°¨ì‹œê°€ ë¯¸ì™„ë£Œ ìƒíƒœì…ë‹ˆë‹¤`);
            }
            
            if (avgLength < 50) {
                improvements.push('í™œë™ ê¸°ë¡ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤ (ê¶Œì¥: 100ì ì´ìƒ)');
            }
            
            const reflectionCount = Object.values(sessionData.reflectionDetails).reduce((sum, arr) => sum + arr.length, 0);
            if (reflectionCount < 10) {
                improvements.push('ì„±ì°°ì¼ì§€ í•­ëª©ì„ ë” ì„ íƒí•˜ë©´ ì¢‹ìŠµë‹ˆë‹¤');
            }
            
            const evaluationCount = Object.values(sessionData.selfEvaluation).reduce((sum, arr) => sum + arr.length, 0);
            if (evaluationCount < 10) {
                improvements.push('ìê¸°í‰ê°€ í•­ëª©ì„ ë” ì„ íƒí•˜ë©´ ì¢‹ìŠµë‹ˆë‹¤');
            }
            
            return {
                completionRate,
                avgLength,
                strengths,
                improvements
            };
        }

        // â­ AI ìƒê¸°ë¶€ ìƒì„± í•¨ìˆ˜ë“¤
        let generatedAISeosaenggibu = '';
        
        async function generateSeosaenggibuWithAI() {
            // ëª¨ë“  í™œë™ ê¸°ë¡ ìˆ˜ì§‘
            const activities = sessionData.executionData
                .map((e, i) => `${i+1}ì°¨ì‹œ [${sessionData.timeline[i].title}]: ${e.content}`)
                .join('\n\n');
            
            // ìê¸°í‰ê°€ ìš”ì•½
            const evalSummary = [];
            const evaluationCategories = [
                'ê³„íš ìˆ˜ë¦½', 'ì‹¤í–‰ ë° ì™„ì„±ë„', 'ë¬¸ì œ í•´ê²°', 'ì°½ì˜ì„±', 'ìê¸°ì£¼ë„ì„±',
                'ì˜ì‚¬ì†Œí†µ', 'ì •ë³´ í™œìš©', 'ì‹œê°„ ê´€ë¦¬', 'ì„±ì°° ë° ê°œì„ ', 'í•™ìŠµ íƒœë„'
            ];
            evaluationCategories.forEach((cat, i) => {
                const items = sessionData.selfEvaluation[`eval_${i}`] || [];
                if (items.length >= 2) {
                    evalSummary.push(`${cat}: ${items.join(', ')}`);
                }
            });
            
            const prompt = `ë‹¹ì‹ ì€ í•™êµìƒí™œê¸°ë¡ë¶€(ìƒê¸°ë¶€) ì„¸ë¶€ëŠ¥ë ¥ ë° íŠ¹ê¸°ì‚¬í•­ì„ ì‘ì„±í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

[í•™ìƒ ì •ë³´]
- í•™ë…„: ${sessionData.grade}
- ì—°ê³„ êµê³¼: ${sessionData.subjects.join(', ')}
- í”„ë¡œì íŠ¸ ì£¼ì œ: ${sessionData.keyword}
- ê³¼ì œëª…: ${sessionData.selectedTask}
- ì´ ì‹œê°„: ${sessionData.totalHours}ì‹œê°„

[ì‹¤ì œ í™œë™ ë‚´ìš©]
${activities}

[í•™ìƒ ìê¸°í‰ê°€ ê°•ì ]
${evalSummary.join('\n')}

ìœ„ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ìƒê¸°ë¶€ ì„¸ë¶€ëŠ¥ë ¥ ë° íŠ¹ê¸°ì‚¬í•­ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.

**ì‘ì„± ê·œì¹™:**
1. 3-4ì¤„ (200-300ì) ë¶„ëŸ‰
2. êµ¬ì²´ì ì¸ í™œë™ ë‚´ìš©ê³¼ ë„êµ¬, ì„±ê³¼ë¥¼ í¬í•¨
3. ì‹¤ì œ í™œë™ ê¸°ë¡ì—ì„œ ì–¸ê¸‰ëœ ë‚´ìš© í™œìš©
4. í•™ìƒì˜ ì—­ëŸ‰(ë¶„ì„ë ¥, ì°½ì˜ì„±, ë¬¸ì œí•´ê²°ë ¥ ë“±)ì´ ë“œëŸ¬ë‚˜ë„ë¡ ì‘ì„±
5. ê³¼ê±°í˜• ë¬¸ì¥ìœ¼ë¡œ ì‘ì„± (~í•˜ì˜€ìœ¼ë©°, ~í•˜ëŠ” ë“±)
6. êµê³¼ ì—°ê³„ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨
7. ì¼ë°˜ì ì´ê³  ì¶”ìƒì ì¸ í‘œí˜„ ì§€ì–‘, êµ¬ì²´ì ì¸ ì‚¬ì‹¤ ìœ„ì£¼
8. ìƒê¸°ë¶€ í˜•ì‹ì— ë§ê²Œ í•œ ë¬¸ë‹¨ìœ¼ë¡œ ì‘ì„± (ì¤„ë°”ê¿ˆ ì—†ì´)

ì˜ˆì‹œ ìŠ¤íƒ€ì¼: "'ê³¼ì œëª…' í”„ë¡œì íŠ¸ë¥¼ ìˆ˜í–‰í•˜ë©° [êµ¬ì²´ì  í™œë™1]í•˜ì˜€ìœ¼ë©°, [êµ¬ì²´ì  ë„êµ¬/ë°©ë²•]ì„ í™œìš©í•˜ì—¬ [êµ¬ì²´ì  ê²°ê³¼]ë¥¼ ë„ì¶œí•˜ëŠ” ë“± [ì—­ëŸ‰]ì„ ë‚˜íƒ€ëƒ„. [ì¶”ê°€ í™œë™2]í•˜ê³  [ì„±ê³¼]ë¥¼ ì œì‹œí•˜ëŠ” ê³¼ì •ì—ì„œ [ì—­ëŸ‰2]ì„ ë°œíœ˜í•¨."`;
            
            showAILoading(true, 'AIê°€ ìƒê¸°ë¶€ë¥¼ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
            
            try {
                const result = await callAI(prompt);
                
                if (result) {
                    generatedAISeosaenggibu = result;
                    
                    // ê²°ê³¼ í‘œì‹œ
                    document.getElementById('aiSeosaenggibuText').textContent = result;
                    document.getElementById('aiSeosaenggibuResult').style.display = 'block';
                    
                    // ë²„íŠ¼ê¹Œì§€ ìŠ¤í¬ë¡¤
                    document.getElementById('aiSeosaenggibuResult').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    showToast('âœ… AI ìƒê¸°ë¶€ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    showToast('âŒ AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('AI ìƒì„± ì˜¤ë¥˜:', error);
                showToast('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                showAILoading(false);
            }
        }
        
        function useAISeosaenggibu() {
            if (!generatedAISeosaenggibu) {
                alert('ìƒì„±ëœ ìƒê¸°ë¶€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // AI ìƒì„± ìƒê¸°ë¶€ë¥¼ ì„¸ì…˜ ë°ì´í„°ì— ì €ì¥
            sessionData.aiGeneratedSeosaenggibu = generatedAISeosaenggibu;
            saveToLocal();
            
            showToast('âœ… AI ìƒê¸°ë¶€ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤! ì œì¶œ ì‹œ ì´ ë‚´ìš©ì´ ì‚¬ìš©ë©ë‹ˆë‹¤.');
            
            // ê²°ê³¼ ì°½ ë‹«ê¸°
            setTimeout(() => {
                document.getElementById('aiSeosaenggibuResult').style.display = 'none';
            }, 1500);
        }
        
        function regenerateSeosaenggibu() {
            document.getElementById('aiSeosaenggibuResult').style.display = 'none';
            setTimeout(() => {
                generateSeosaenggibuWithAI();
            }, 300);
        }

        function submitSelfEvaluation() {
            const evaluations = generateSelfEvaluations();
            for (let i = 0; i < evaluations.length; i++) {
                const categoryKey = `eval_${i}`;
                if (!sessionData.selfEvaluation[categoryKey] || sessionData.selfEvaluation[categoryKey].length === 0) {
                    alert(`ìê¸°í‰ê°€ì„œë¥¼ ì™„ì„±í•´ì£¼ì„¸ìš”.\nëª¨ë“  ì˜ì—­ì—ì„œ ìµœì†Œ 1ê°œì”© ì„ íƒí•´ì£¼ì„¸ìš”.`);
                    return;
                }
            }
            
            sessionData.reviewCompleted = true;
            sessionData.step = 7;
            saveToLocal();
            showToast('âœ… ìê¸°í‰ê°€ ì™„ë£Œ');
            renderQuiz();
        }

        // ==========================================
        // 7ë‹¨ê³„: ì´í•´ë„ í€´ì¦ˆ
        // ==========================================
        function renderQuiz() {
            const questions = generateQuizQuestions();
            sessionData.quizQuestions = questions;
            sessionData.quizAnswers = [];
            
            updateProgress();
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <div class="step-indicator">[7/8 ë‹¨ê³„] ì´í•´ë„ í™•ì¸ í€´ì¦ˆ</div>
                ${renderDataSummary()}
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; text-align: center;">
                    <h2 style="margin-bottom: 15px;">ğŸ“ ì´í•´ë„ í™•ì¸ í€´ì¦ˆ</h2>
                    <p style="opacity: 0.95; line-height: 1.6;">
                        í”„ë¡œì íŠ¸ ë‚´ìš©ì„ ì œëŒ€ë¡œ ì´í•´í–ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.<br>
                        10ë¬¸ì œ ì¤‘ 7ê°œ ì´ìƒ ë§í˜€ì•¼ í•©ë‹ˆë‹¤. (ë¬´ì œí•œ ì¬ë„ì „ ê°€ëŠ¥)
                    </p>
                </div>
                
                <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                    <h4 style="color: #1e40af; margin-bottom: 10px;">ğŸ“Œ í€´ì¦ˆ ì•ˆë‚´</h4>
                    <ul style="color: #1e3a8a; padding-left: 20px; line-height: 1.8;">
                        <li>OX ë¬¸ì œ 5ê°œ + 4ì§€ì„ ë‹¤ 5ê°œ</li>
                        <li>í”„ë¡œì íŠ¸ì—ì„œ ì‘ì„±í•œ ë‚´ìš© ê¸°ë°˜ ì¶œì œ</li>
                        <li>í†µê³¼ ê¸°ì¤€: 10ë¬¸ì œ ì¤‘ 7ê°œ ì´ìƒ (70%)</li>
                        <li>íŒíŠ¸ ì—†ìŒ, ë¬´ì œí•œ ì¬ë„ì „ ê°€ëŠ¥</li>
                    </ul>
                </div>
                
                <div class="quiz-container">
                    ${questions.map((q, index) => `
                        <div class="quiz-question">
                            <h4 style="color: #374151; margin-bottom: 15px;">
                                ${index + 1}. ${q.question}
                            </h4>
                            <div class="quiz-options">
                                ${q.options.map((opt, optIndex) => `
                                    <div class="quiz-option" onclick="selectQuizOption(${index}, ${optIndex})">
                                        <input type="radio" name="quiz_${index}" id="quiz_${index}_${optIndex}">
                                        <label for="quiz_${index}_${optIndex}">${opt}</label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="renderStep(6)">â—€ ìê¸°í‰ê°€ë¡œ</button>
                    <button class="btn btn-primary" onclick="submitQuiz()">í€´ì¦ˆ ì œì¶œí•˜ê¸°</button>
                </div>
            `;
        }

        function generateQuizQuestions() {
            const questions = [];
            
            questions.push({
                type: 'ox',
                question: `ì´ í”„ë¡œì íŠ¸ì˜ í•µì‹¬ í‚¤ì›Œë“œëŠ” "${sessionData.keyword}"ì´ë‹¤.`,
                options: ['O', 'X'],
                correctAnswer: 0
            });
            
            questions.push({
                type: 'ox',
                question: `${sessionData.timeline[0].title}ì€/ëŠ” 1ì°¨ì‹œì—ì„œ ìˆ˜í–‰í•œ í™œë™ì´ë‹¤.`,
                options: ['O', 'X'],
                correctAnswer: 0
            });
            
            questions.push({
                type: 'ox',
                question: `ì´ í”„ë¡œì íŠ¸ ì‹œê°„ì€ ${sessionData.totalHours}ì‹œê°„ì´ë‹¤.`,
                options: ['O', 'X'],
                correctAnswer: 0
            });
            
            const completedCount = sessionData.executionData ? sessionData.executionData.length : 0;
            questions.push({
                type: 'ox',
                question: `ì‹¤í–‰ ì™„ë£Œí•œ ì°¨ì‹œëŠ” ì´ ${completedCount}ê°œì´ë‹¤.`,
                options: ['O', 'X'],
                correctAnswer: 0
            });
            
            const learnings = sessionData.reflectionDetails.learnings && sessionData.reflectionDetails.learnings.length > 0
                ? sessionData.reflectionDetails.learnings[0] 
                : 'ë¬¸ì œ í•´ê²° ëŠ¥ë ¥';
            questions.push({
                type: 'ox',
                question: `ì´ í”„ë¡œì íŠ¸ì—ì„œ ë°°ìš´ ì  ì¤‘ í•˜ë‚˜ëŠ” "${learnings}"ì´ë‹¤.`,
                options: ['O', 'X'],
                correctAnswer: 0
            });
            
            const wrongTasks = ['í•™êµí­ë ¥ ì˜ˆë°© ìº í˜ì¸', 'í™˜ê²½ì˜¤ì—¼ ì‹¤íƒœ ì¡°ì‚¬', 'ì§„ë¡œ íƒìƒ‰ ë³´ê³ ì„œ', 'ë…ì„œ ê°ìƒë¬¸ ì‘ì„±'];
            const taskOptions = [sessionData.selectedTask, ...wrongTasks.slice(0, 3)].sort(() => Math.random() - 0.5);
            questions.push({
                type: 'choice',
                question: 'ì„ íƒí•œ í”„ë¡œì íŠ¸ ê³¼ì œëŠ”?',
                options: taskOptions,
                correctAnswer: taskOptions.indexOf(sessionData.selectedTask)
            });
            
            const wrongActivities = ['ë°œí‘œ ì¤€ë¹„', 'ìµœì¢… ê²€í† ', 'íŒ€ íšŒì˜', 'ìë£Œ ì •ë¦¬'];
            const secondStepTitle = sessionData.timeline.length >= 2 ? sessionData.timeline[1].title : sessionData.timeline[0].title;
            const activityOptions = [secondStepTitle, ...wrongActivities.slice(0, 3)].sort(() => Math.random() - 0.5);
            questions.push({
                type: 'choice',
                question: `${sessionData.timeline.length >= 2 ? '2' : '1'}ì°¨ì‹œì˜ ì£¼ìš” í™œë™ì€?`,
                options: activityOptions,
                correctAnswer: activityOptions.indexOf(secondStepTitle)
            });
            
            const wrongSubjects = ['êµ­ì–´, ìˆ˜í•™', 'ì˜ì–´, ê³¼í•™', 'ì²´ìœ¡, ìŒì•…', 'ë¯¸ìˆ , ê¸°ìˆ '];
            const correctSubjects = sessionData.subjects.slice(0, 2).join(', ');
            const subjectOptions = [correctSubjects, ...wrongSubjects.slice(0, 3)].sort(() => Math.random() - 0.5);
            questions.push({
                type: 'choice',
                question: 'ì—°ê³„ êµê³¼ëŠ”?',
                options: subjectOptions,
                correctAnswer: subjectOptions.indexOf(correctSubjects)
            });
            
            const difficulties = sessionData.reflectionDetails.difficulties;
            if (difficulties && difficulties.length > 0) {
                const wrongDifficulties = ['íŒ€ì›ê³¼ì˜ ê°ˆë“±', 'ì˜ˆì‚° ë¶€ì¡±', 'ì¥ì†Œ í™•ë³´ ì–´ë ¤ì›€'];
                const diffShort = difficulties[0].substring(0, 30) + '...';
                const diffOptions = [diffShort, ...wrongDifficulties].sort(() => Math.random() - 0.5);
                questions.push({
                    type: 'choice',
                    question: 'í”„ë¡œì íŠ¸ ìˆ˜í–‰ ì¤‘ ê²ªì€ ì–´ë ¤ì›€ì€?',
                    options: diffOptions,
                    correctAnswer: diffOptions.indexOf(diffShort)
                });
            } else {
                const gradeOptions = [sessionData.grade, 'ì¤‘1', 'ì¤‘2', 'ê³ 1'].filter((v, i, a) => a.indexOf(v) === i).slice(0, 4);
                questions.push({
                    type: 'choice',
                    question: 'ì´ í”„ë¡œì íŠ¸ì˜ í•™ë…„ì€?',
                    options: gradeOptions,
                    correctAnswer: 0
                });
            }
            
            const motivations = sessionData.reflectionDetails.motivation;
            if (motivations && motivations.length > 0) {
                const wrongMotivations = ['ì„±ì ì„ ì˜¬ë¦¬ê¸° ìœ„í•´', 'ì„ ìƒë‹˜ê»˜ì„œ ì‹œì¼œì„œ', 'ì¹œêµ¬ ë”°ë¼ì„œ'];
                const motivShort = motivations[0].substring(0, 30) + '...';
                const motivOptions = [motivShort, ...wrongMotivations].sort(() => Math.random() - 0.5);
                questions.push({
                    type: 'choice',
                    question: 'í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í•œ ë™ê¸°ëŠ”?',
                    options: motivOptions,
                    correctAnswer: motivOptions.indexOf(motivShort)
                });
            } else {
                const gradeOptions = [sessionData.grade, 'ì¤‘1', 'ì¤‘2', 'ê³ 1'].filter((v, i, a) => a.indexOf(v) === i).slice(0, 4);
                questions.push({
                    type: 'choice',
                    question: 'ì´ í”„ë¡œì íŠ¸ì˜ í•™ë…„ì€?',
                    options: gradeOptions,
                    correctAnswer: 0
                });
            }
            
            return questions;
        }

        function selectQuizOption(questionIndex, optionIndex) {
            sessionData.quizAnswers[questionIndex] = optionIndex;
            
            document.querySelectorAll(`input[name="quiz_${questionIndex}"]`).forEach((radio, idx) => {
                radio.checked = (idx === optionIndex);
                radio.closest('.quiz-option').classList.toggle('selected', idx === optionIndex);
            });
        }

        function submitQuiz() {
            if (sessionData.quizAnswers.length < 10) {
                alert('ëª¨ë“  ë¬¸ì œì— ë‹µí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            let correctCount = 0;
            sessionData.quizQuestions.forEach((q, index) => {
                if (sessionData.quizAnswers[index] === q.correctAnswer) {
                    correctCount++;
                }
            });
            
            const score = (correctCount / 10) * 100;
            
            if (correctCount >= 7) {
                sessionData.quizPassed = true;
                saveToLocal();
                alert(`âœ… í€´ì¦ˆ í†µê³¼!\n\nì ìˆ˜: ${correctCount}/10 (${score}ì )\n\nìµœì¢… ë³´ê³ ì„œ ë‹¨ê³„ë¡œ ì´ë™í•©ë‹ˆë‹¤.`);
                sessionData.step = 8;
                renderStep(8);
            } else {
                alert(`âŒ í†µê³¼í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n\nì ìˆ˜: ${correctCount}/10 (${score}ì )\nìµœì†Œ 7ê°œ ì´ìƒ ë§í˜€ì•¼ í•©ë‹ˆë‹¤.\n\nì‘ì„±í•œ ë‚´ìš©ì„ ë‹¤ì‹œ í™•ì¸í•˜ê³  ì¬ë„ì „í•˜ì„¸ìš”!`);
                renderQuiz();
            }
        }

        // ==========================================
        // 8ë‹¨ê³„: ìµœì¢… ë³´ê³ ì„œ
        // ==========================================
        function renderFinalReport() {
            if (!sessionData.quizPassed) {
                alert('ì´í•´ë„ í€´ì¦ˆë¥¼ ë¨¼ì € í†µê³¼í•´ì•¼ í•©ë‹ˆë‹¤.');
                renderQuiz();
                return;
            }
            
            const report = generateReport();
            
            return `
                <div class="step-indicator">[8/8 ë‹¨ê³„] í”„ë¡œì íŠ¸ ì™„ì„±! ğŸ‰</div>
                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 25px; border-radius: 12px; margin-bottom: 30px; text-align: center;">
                    <h2 style="color: #92400e; margin-bottom: 10px;">ğŸŠ ì¶•í•˜í•©ë‹ˆë‹¤!</h2>
                    <p style="color: #78350f; font-size: 16px; line-height: 1.6;">
                        <strong>${sessionData.studentName}</strong>ë‹˜ì˜ í”„ë¡œì íŠ¸ê°€ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!
                    </p>
                    <p style="color: #78350f; font-size: 14px; margin-top: 15px;">
                        í•™ë²ˆ: <strong>${sessionData.studentId}</strong> | ì´ë¦„: <strong>${sessionData.studentName}</strong>
                    </p>
                </div>
                <h3 style="margin-bottom: 15px; color: #374151;">ğŸ“„ ìµœì¢… í”„ë¡œì íŠ¸ ë³´ê³ ì„œ</h3>
                <div class="report-box" id="reportBox">${report}</div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="downloadReport()" style="flex: 2;">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</button>
                    <button class="btn btn-secondary" onclick="copyReport()" style="flex: 1;">ğŸ“‹ ë³µì‚¬</button>
                    <button class="btn btn-primary" onclick="submitToTeacher()" style="flex: 2;">ğŸ“¤ ì„ ìƒë‹˜ê»˜ ì œì¶œ</button>
                </div>
                <div style="background: #f0f9ff; border: 2px solid #3b82f6; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h4 style="color: #1e40af; margin-bottom: 12px;">ğŸ“Œ ì œì¶œ ë°©ë²• ì•ˆë‚´</h4>
                    <div style="color: #1e3a8a; line-height: 1.8; font-size: 14px;">
                        <strong>âœ… ì˜¨ë¼ì¸ ì œì¶œ (ê¶Œì¥)</strong><br>
                        "ğŸ“¤ ì„ ìƒë‹˜ê»˜ ì œì¶œ" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ìë™ìœ¼ë¡œ ì œì¶œë©ë‹ˆë‹¤.
                        <br><br>
                        <strong>ğŸ’¾ ì§ì ‘ ì œì¶œ (ì˜¨ë¼ì¸ ì œì¶œ ì‹¤íŒ¨ ì‹œ)</strong><br>
                        "ğŸ’¾ ë‹¤ìš´ë¡œë“œ" ë²„íŠ¼ìœ¼ë¡œ íŒŒì¼ì„ ì €ì¥í•œ í›„<br>
                        ì´ë©”ì¼, USB, í´ë˜ìŠ¤ë£¸ ë“±ìœ¼ë¡œ ì„ ìƒë‹˜ê»˜ ì „ë‹¬í•˜ì„¸ìš”.
                        <br><br>
                        <strong style="color: #b45309;">ğŸ“Œ ì œì¶œ í™•ì¸</strong><br>
                        í•™ë²ˆ <strong>${sessionData.studentId}</strong>ë¡œ ì œì¶œë©ë‹ˆë‹¤.
                    </div>
                </div>
                <div class="btn-group" style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="goToStep(6)">âœï¸ ìê¸°í‰ê°€ ìˆ˜ì •</button>
                    <button class="btn btn-secondary" onclick="resetProject()" style="background: #ef4444; color: white;">ğŸ”„ ìƒˆ í”„ë¡œì íŠ¸ ì‹œì‘</button>
                </div>
            `;
        }

        function generateReport() {
            const now = new Date().toLocaleString('ko-KR');
            
            const reflectionText = Object.entries({
                'í”„ë¡œì íŠ¸ ë™ê¸°': sessionData.reflectionDetails.motivation,
                'ë‚˜ì˜ ì—­í• ': sessionData.reflectionDetails.role,
                'ì–´ë ¤ì›€ ê·¹ë³µ': sessionData.reflectionDetails.difficulties,
                'ë°°ìš´ ì ': sessionData.reflectionDetails.learnings,
                'ì•„ì‰¬ìš´ ì ': sessionData.reflectionDetails.regrets,
                'í–¥í›„ ë°œì „': sessionData.reflectionDetails.future
            }).map(([title, items]) => `
ã€${title}ã€‘
${items.map((item, i) => `  ${i + 1}. ${item}`).join('\n')}
            `).join('\n');
            
            const evaluations = generateSelfEvaluations();
            const evaluationText = evaluations.map((category, index) => {
                const categoryKey = `eval_${index}`;
                const selected = sessionData.selfEvaluation[categoryKey] || [];
                return `
ã€${category.category}ã€‘
${selected.map((item, i) => `  ${i + 1}. ${item}`).join('\n')}
                `;
            }).join('\n');
            
            return `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   í”„ë¡œì íŠ¸ í•™ìŠµ ë³´ê³ ì„œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“… ì‘ì„±ì¼ì‹œ: ${now}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. í•™ìƒ ì •ë³´
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

í•™ë²ˆ: ${sessionData.studentId}
ì´ë¦„: ${sessionData.studentName}
í•™ë…„: ${sessionData.grade}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
2. í”„ë¡œì íŠ¸ ê°œìš”
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ì—°ê³„ êµê³¼: ${sessionData.subjects.join(', ')}
í•´ê²° ê³¼ì œ: ${sessionData.keyword}
í”„ë¡œì íŠ¸ëª…: ${sessionData.selectedTask}
ì˜ˆìƒ ì†Œìš”: ${sessionData.totalHours}ì‹œê°„

[ê³¼ì œ ì„¤ëª…]
${sessionData.selectedTaskData.description}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
3. ì‹¤í–‰ ê³„íš ë° ê¸°ë¡
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${sessionData.timeline.map((item, index) => {
    const execution = sessionData.executionData && sessionData.executionData[index];
    return `
ã€${index + 1}ì‹œê°„ì°¨ã€‘ ${item.title}
â±ï¸ ê³„íš: ${item.duration}ë¶„
ğŸ¯ ë¯¸ì…˜: ${item.mission}

ì„¸ë¶€ í™œë™:
${item.activities.map((act, i) => `  ${i + 1}. ${act}`).join('\n')}

${execution ? `
âœï¸ í™œë™ ê¸°ë¡:
${execution.content}
${execution.completedAt ? `(ì™„ë£Œ: ${new Date(execution.completedAt).toLocaleString('ko-KR')})` : ''}
` : '(ì•„ì§ ìˆ˜í–‰í•˜ì§€ ì•ŠìŒ)'}
`;
}).join('\n')}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
4. ì„±ì°°ì¼ì§€
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${reflectionText}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
5. ìê¸°í‰ê°€
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${evaluationText}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
6. ìƒí™œê¸°ë¡ë¶€ ì°¸ê³ ì‚¬í•­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[${sessionData.subjects[0]}] 
'${sessionData.keyword}' ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ í”„ë¡œì íŠ¸ë¥¼ 
ìê¸°ì£¼ë„ì ìœ¼ë¡œ ìˆ˜í–‰í•¨. '${sessionData.selectedTask}'ë¼ëŠ” 
ì£¼ì œë¡œ ${sessionData.totalHours}ì‹œê°„ ë¶„ëŸ‰ì˜ ì²´ê³„ì ì¸ ì‹¤í–‰ 
ê³„íšì„ ìˆ˜ë¦½í•˜ì˜€ìœ¼ë©°, ë¬¸ì œ ì¸ì‹ë¶€í„° í•´ê²° ë°©ì•ˆ ë„ì¶œ, 
ì‹¤ì œ ì‹¤í–‰ê¹Œì§€ ì™„ìˆ˜í•¨. í”„ë¡œì íŠ¸ ê³¼ì •ì—ì„œ ${sessionData.reflectionDetails.learnings.slice(0, 2).join(', ')} ë“±ì˜ 
ì—­ëŸ‰ì„ í•¨ì–‘í•˜ì˜€ìœ¼ë©°, ì„±ì°°ì„ í†µí•´ ìì‹ ì˜ ì„±ì¥ì„ 
ê°ê´€ì ìœ¼ë¡œ í‰ê°€í•˜ëŠ” ë©”íƒ€ì¸ì§€ ëŠ¥ë ¥ì„ ë³´ì—¬ì¤Œ.

[í•µì‹¬ì—­ëŸ‰]
- ë¬¸ì œí•´ê²°ë ¥: ì§€ì—­ì‚¬íšŒ ë¬¸ì œë¥¼ ìŠ¤ìŠ¤ë¡œ ë°œê²¬í•˜ê³  í•´ê²° ë°©ì•ˆ íƒìƒ‰
- ìê¸°ì£¼ë„ì„±: í”„ë¡œì íŠ¸ ì „ ê³¼ì •ì„ ì£¼ë„ì ìœ¼ë¡œ ì„¤ê³„ ë° ì‹¤í–‰
- ì°½ì˜ì„±: ${sessionData.selectedTaskData.title}ë¥¼ í†µí•œ ì°½ì˜ì  ì ‘ê·¼
- ì„±ì°°ëŠ¥ë ¥: í”„ë¡œì íŠ¸ ì „ë°˜ì— ëŒ€í•œ ê¹Šì´ ìˆëŠ” ì„±ì°°ê³¼ ìê¸°í‰ê°€

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            ë³´ê³ ì„œ ë
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            `.trim();
        }

        function copyReport() {
            const report = document.getElementById('reportBox').textContent;
            navigator.clipboard.writeText(report).then(() => {
                showToast('âœ… ë³´ê³ ì„œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }).catch(() => {
                alert('ë³µì‚¬ ì‹¤íŒ¨. ìˆ˜ë™ìœ¼ë¡œ ì„ íƒí•˜ì—¬ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
            });
        }

        function downloadReport() {
            const report = generateReport();
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `í”„ë¡œì íŠ¸ë³´ê³ ì„œ_${sessionData.studentId}_${sessionData.studentName}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('âœ… ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!');
        }

        async function submitToTeacher() {
            if (API_ENDPOINT === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                const confirmDownload = confirm('âš ï¸ ì˜¨ë¼ì¸ ì œì¶œ ê¸°ëŠ¥ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\nğŸ“‹ ë³´ê³ ì„œë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì„ ìƒë‹˜ê»˜ ì§ì ‘ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                if (confirmDownload) downloadReport();
                return;
            }
            
            if (sessionData.isSubmitted) {
                const resubmit = confirm('ì´ë¯¸ ì œì¶œí•œ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.\n\në‹¤ì‹œ ì œì¶œí•˜ë©´ ê¸°ì¡´ ë‚´ìš©ì´ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                if (!resubmit) return;
            }
            
            if (!confirm('ì„ ìƒë‹˜ê»˜ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì œì¶œ í›„ì—ë„ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.')) return;
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'ğŸ“¤ ì œì¶œ ì¤‘...';
            
            try {
                sessionData.isSubmitted = true;
                sessionData.submittedAt = new Date().toISOString();
                
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {'Content-Type': 'text/plain'},
                    body: JSON.stringify({action: 'submit', data: sessionData})
                });
                
                if (!response.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
                
                const text = await response.text();
                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    result = { success: true };
                }
                
                if (result.success) {
                    saveToLocal();
                    showToast('âœ… ì œì¶œ ì™„ë£Œ!');
                    let message = `ì œì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! âœ…\n\ní•™ë²ˆ: ${sessionData.studentId}\nì´ë¦„: ${sessionData.studentName}\nì œì¶œì¼ì‹œ: ${new Date().toLocaleString('ko-KR')}\n\nâ€» ì„ ìƒë‹˜ê»˜ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
                    if (result.data && result.data.updated) message += `\n\nâ€» ê¸°ì¡´ ì œì¶œ ë‚´ì—­ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    alert(message);
                    btn.textContent = 'âœ… ì œì¶œ ì™„ë£Œ';
                    btn.style.background = '#10b981';
                } else {
                    throw new Error(result.message || 'ì œì¶œ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('ì œì¶œ ì˜¤ë¥˜:', error);
                let errorMsg = 'âŒ ì˜¨ë¼ì¸ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nğŸ“‹ ëŒ€ì‹  ë³´ê³ ì„œë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì˜¤ë¥˜ ì›ì¸:\n';
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMsg += 'â€¢ ì¸í„°ë„· ì—°ê²° ë¬¸ì œ\nâ€¢ êµ¬ê¸€ ì‹œíŠ¸ URL ì˜¤ë¥˜\n';
                } else if (error.message.includes('CORS')) {
                    errorMsg += 'â€¢ ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±… ë¬¸ì œ\nâ€¢ êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ì„¤ì • í™•ì¸ í•„ìš”\n';
                } else {
                    errorMsg += `â€¢ ${error.message}\n`;
                }
                const shouldDownload = confirm(errorMsg);
                if (shouldDownload) {
                    downloadReport();
                    showToast('ğŸ’¾ ë³´ê³ ì„œë¥¼ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤. ì„ ìƒë‹˜ê»˜ ì§ì ‘ ì œì¶œí•´ì£¼ì„¸ìš”.');
                } else {
                    sessionData.isSubmitted = false;
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            }
        }

        function resetProject() {
            if (confirm('ì •ë§ ìƒˆë¡œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ë‚´ìš©ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) {
                localStorage.removeItem('projectData');
                location.reload();
            }
        }

        function init() {
        console.log('ğŸš€ ì‹œìŠ¤í…œ ì´ˆê¸°í™”...');
        try {
            const hasData = loadFromLocal();
            if (hasData && sessionData.step > 0) {
                if (sessionData.currentExecutionStep !== undefined && sessionData.timeline && sessionData.currentExecutionStep < sessionData.timeline.length) {
                    if (confirm('ì´ì „ì— ì§„í–‰í•˜ë˜ í”„ë¡œì íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤.\nì‹¤í–‰ ì¤‘ì´ë˜ ì°¨ì‹œë¶€í„° ì´ì–´ì„œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        renderExecutionStep(sessionData.currentExecutionStep);
                        return;
                    }
                }
                if (confirm('ì´ì „ì— ì‘ì„±í•˜ë˜ í”„ë¡œì íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤.\nì´ì–´ì„œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    renderStep(sessionData.step);
                } else {
                    localStorage.removeItem('projectData');
                    sessionData.step = 0;
                    renderStep(0);
                }
            } else {
                renderStep(0);
            }
        } catch (error) {
            console.error('âŒ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            const contentDiv = document.getElementById('content');
            if (contentDiv) {
                contentDiv.innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                        <h2 style="color: #ef4444;">âš ï¸ ì‹œìŠ¤í…œ ì˜¤ë¥˜</h2>
                        <p style="color: #6b7280; margin: 20px 0;">ì´ˆê¸°í™” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                        <button class="btn btn-primary" onclick="localStorage.clear(); location.reload();">
                            ë‹¤ì‹œ ì‹œì‘
                        </button>
                    </div>
                `;
            }
        }
        }

        window.onload = init;
    </script>
</body>
</html>
